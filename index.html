<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¬ìŠ¤í„° ëŸ¬ì‰¬: íŒœ ìŠ¤í…Œì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ê·€ì—¬ìš´ í°íŠ¸ (Jua) ì¶”ê°€ -->
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        /* ê¸°ë³¸ ì„¤ì • */
        body {
            font-family: 'Jua', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
            background-color: #1c1917;
            margin: 0;
            padding: 0;
        }
        
        /* í™”ë©´ í”ë“¤ë¦¼ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake-screen {
            animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        /* ìƒë‹¨ HUD ë°” */
        .hud-bar {
            height: 100px;
            background: #1c1917;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            pointer-events: auto;
            border-bottom: 6px solid #44403c;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 100;
            position: relative;
        }

        /* ê²Œì„ ì•„ë ˆë‚˜ */
        #game-arena {
            position: absolute;
            top: 100px;
            left: 0;
            width: 100vw;
            height: calc(100vh - 100px);
            background-color: #4ade80;
            
            /* ê²Œì„ ë°°ê²½ ì´ë¯¸ì§€ */
            background-image: url('https://raw.githubusercontent.com/chalchichi/testresource/main/Gemini_Generated_Image_p0oedlp0oedlp0oe.png'); 
            
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            
            cursor: crosshair;
            z-index: 0;
            overflow: hidden;
        }

        .hud-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .hud-label {
            font-size: 1rem;
            color: #d6d3d1;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
        }
        .hud-value {
            font-family: 'Jua', sans-serif;
            font-size: 2rem;
            line-height: 1;
        }

        /* íƒ€ì´ë¨¸ ì „ìš© ìŠ¤íƒ€ì¼ */
        #timer {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
            min-width: 120px;
            text-align: center;
        }

        /* ëª¬ìŠ¤í„° ì—”í‹°í‹° */
        .monster-entity {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 64px;
            height: 64px;
            cursor: pointer;
            will-change: transform;
            filter: drop-shadow(0 6px 4px rgba(0,0,0,0.4));
            transition: opacity 0.3s, transform 0.1s;
        }

        /* í’€ìˆ² ì¥ì• ë¬¼ ìŠ¤íƒ€ì¼ */
        .bush-obstacle {
            position: absolute;
            width: 120px;
            height: 100px;
            pointer-events: none; /* í´ë¦­ í†µê³¼ (ëª¬ìŠ¤í„° í´ë¦­ ë°©í•´ X, ì‹œì•¼ë§Œ ê°€ë¦¼) */
            z-index: 9990; /* ëª¬ìŠ¤í„°ë³´ë‹¤ ìœ„ì— í‘œì‹œ */
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3));
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }
        
        .bush-svg {
            width: 100%;
            height: 100%;
            fill: #15803d; /* ì§™ì€ ì´ˆë¡ìƒ‰ */
            stroke: #052e16;
            stroke-width: 3px;
        }

        /* ì‹œì‘ í™”ë©´ ì˜¤ë²„ë ˆì´ */
        #start-screen {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* ì‹œì‘ ë©”ë‰´ íŒ¨ë„ */
        .start-panel {
            background-image: url('https://raw.githubusercontent.com/chalchichi/testresource/main/background.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            
            border: 8px solid #ffffff;
            border-radius: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 0 10px rgba(0,0,0,0.1);
            padding: 50px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .game-title {
            font-size: 4.5rem;
            color: #ffffff;
            -webkit-text-stroke: 8px #15803d; 
            paint-order: stroke fill;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            line-height: 1;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            color: #1c1917;
            position: relative;
            z-index: 10;
            border: 3px solid #e5e7eb;
        }

        .start-btn {
            background: linear-gradient(to bottom, #4ade80, #16a34a);
            color: white;
            font-size: 2.2rem;
            padding: 15px 40px;
            border-radius: 20px;
            box-shadow: 0 6px 0 #14532d, 0 10px 10px rgba(0,0,0,0.2);
            transition: all 0.1s;
            display: inline-block;
            width: 100%;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
            border: 2px solid #ffffff;
        }

        .start-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #14532d;
        }

        .ranking-box {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 16px;
            padding: 15px;
            margin-top: 24px;
            border: 2px solid rgba(255,255,255,0.3);
            position: relative;
            z-index: 10;
        }

        /* ëª¬ìŠ¤í„° ê³µí†µ ìŠ¤íƒ€ì¼ */
        .monster-body { width: 100%; height: 100%; position: relative; }
        .slime-body { fill: var(--monster-color); stroke: #14532d; stroke-width: 2.5px; }
        .slime-anim { animation: slime-bounce 0.6s infinite alternate cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slime-bounce { 0% { transform: scaleY(0.9) scaleX(1.1) translateY(5px); } 100% { transform: scaleY(1.1) scaleX(0.9) translateY(-5px); } }

        .mushroom-cap { fill: var(--monster-color); stroke: #14532d; stroke-width: 2.5px; }
        .mushroom-stem { fill: #fff3e0; stroke: #14532d; stroke-width: 2.5px; }
        .mushroom-anim { animation: mushroom-walk 0.4s infinite alternate ease-in-out; }
        @keyframes mushroom-walk { 0% { transform: rotate(-5deg); } 100% { transform: rotate(5deg); } }

        .bat-body { fill: var(--monster-color); stroke: #14532d; stroke-width: 2.5px; }
        .bat-wing { fill: var(--monster-dark-color); stroke: #14532d; stroke-width: 1px; }
        .bat-anim { animation: bat-fly 0.2s infinite alternate ease-in-out; }
        @keyframes bat-fly { 0% { transform: translateY(0); } 100% { transform: translateY(-8px); } }

        .ghost-body { fill: #f8fafc; stroke: #14532d; stroke-width: 2.5px; opacity: 0.95; }
        .ghost-anim { animation: ghost-float 1.5s infinite ease-in-out; }
        @keyframes ghost-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }

        .eye { fill: white; }
        .pupil { fill: #14532d; }

        .number-badge {
            position: absolute;
            top: -18px;
            background: #fbbf24;
            color: #1c1917;
            font-size: 16px;
            font-weight: 900;
            padding: 2px 10px;
            border-radius: 12px;
            border: 3px solid #ffffff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 20;
        }

        .dead { pointer-events: none; opacity: 0; transform: scale(0); transition: all 0.3s; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #5d4037; border-radius: 10px; }

    </style>
</head>
<body>

    <div class="hud-bar">
        <div class="hud-item">
            <span class="hud-label">STAGE</span>
            <span class="hud-value text-yellow-400" id="stage-display">1</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">TARGET</span>
            <div class="hud-value text-white bg-stone-800 px-4 py-1 rounded-xl border-2 border-stone-600">
                <span id="current-target">1</span>
                <span class="text-xl text-stone-500 font-normal">/ <span id="total-monsters-display">10</span></span>
            </div>
        </div>
        <div class="hud-item ml-10">
            <span class="hud-label">TIME</span>
            <span class="hud-value text-green-400" id="timer">0.000</span>
        </div>
        <button id="reset-button" class="absolute right-8 bg-stone-800 hover:bg-stone-700 text-white p-3 rounded-2xl border-b-4 border-stone-950 transition-all active:border-b-0 active:translate-y-1">
            ğŸ”„ RESET
        </button>
    </div>

    <div id="game-arena"></div>

    <div id="start-screen">
        <div class="start-panel">
            <div class="text-8xl mb-2 drop-shadow-xl relative z-10 animate-bounce">ğŸ‘»</div>
            <h1 class="game-title">MONSTER<br>RUSH</h1>
            
            <div class="info-box">
                <p class="text-xl font-bold text-stone-800">1ë²ˆë¶€í„° ì°¨ë¡€ëŒ€ë¡œ ì¡ì•„ì£¼ì„¸ìš”!</p>
                <p id="stage-info-text" class="text-green-600 text-base mt-1 font-bold">ğŸŒ± Stage 1: 10ë§ˆë¦¬ ì¶œëª°!</p>
            </div>
            
            <button id="start-button" class="start-btn">GAME START</button>

            <div class="ranking-box">
                <h2 class="text-xs font-black text-white uppercase tracking-widest mb-2 border-b border-white/20 pb-1">HALL OF FAME</h2>
                <ul id="leaderboard" class="space-y-2 text-sm max-h-32 overflow-y-auto custom-scrollbar text-left p-1">
                    <li class="text-center text-stone-300 text-xs py-2">ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ê²Œì„ ë°¸ëŸ°ìŠ¤ ìƒìˆ˜
        const SPEED_MIN_BASE = 0.3;
        const SPEED_MAX_BASE = 0.8;
        const TIMEOUT_LIMIT = 100.0; // 100ì´ˆ ì œí•œ

        const gameArena = document.getElementById('game-arena');
        const currentTargetDisplay = document.getElementById('current-target');
        const totalMonstersDisplay = document.getElementById('total-monsters-display');
        const stageDisplay = document.getElementById('stage-display');
        const timerDisplay = document.getElementById('timer');
        const startScreen = document.getElementById('start-screen');
        const stageInfoText = document.getElementById('stage-info-text');
        const leaderboardEl = document.getElementById('leaderboard');
        
        // ìƒíƒœ ë³€ìˆ˜
        let currentStage = 1;
        let totalMonstersInStage = 10;
        let currentTarget = 1;
        let isGameRunning = false;
        let startTime = 0;
        let timerInterval = null;
        let animId = null;
        let monsters = [];

        let app, db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const COLLECTION_PATH = `/artifacts/${appId}/public/data/leaderboard_cute_stage`;

        function getMonsterHTML(type, color, darkColor) {
            const eyes = `
                <circle class="eye" cx="24" cy="28" r="6" />
                <circle class="pupil" cx="24" cy="28" r="2.5" />
                <circle class="eye" cx="40" cy="28" r="6" />
                <circle class="pupil" cx="40" cy="28" r="2.5" />
            `;

            if (type === 'slime') {
                return `<div class="monster-body slime-anim" style="--monster-color: ${color}"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="slime-body" d="M10,45 Q10,15 32,15 Q54,15 54,45 Q54,58 50,60 Q32,64 14,60 Q10,58 10,45 Z" />${eyes}</svg></div>`;
            } else if (type === 'mushroom') {
                return `<div class="monster-body mushroom-anim" style="--monster-color: ${color}"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="mushroom-stem" d="M22,60 L22,35 L42,35 L42,60 Q32,64 22,60 Z" /><path class="mushroom-cap" d="M6,35 Q32,0 58,35 Z" />${eyes}</svg></div>`;
            } else if (type === 'bat') {
                return `<div class="monster-body bat-anim" style="--monster-color: ${color}; --monster-dark-color: ${darkColor}"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="bat-wing" d="M10,30 Q-5,10 20,25 L20,35 Z" /><path class="bat-wing" d="M54,30 Q69,10 44,25 L44,35 Z" /><ellipse class="bat-body" cx="32" cy="35" rx="14" ry="16" />${eyes}</svg></div>`;
            } else {
                return `<div class="monster-body ghost-anim"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="ghost-body" d="M12,60 L12,30 Q12,10 32,10 Q52,10 52,30 L52,60 L42,50 L32,60 L22,50 L12,60 Z" />${eyes}</svg></div>`;
            }
        }

        function getBushHTML() {
            return `
                <svg class="bush-svg" viewBox="0 0 100 80">
                    <path d="M10,80 Q-10,40 20,30 Q10,10 40,15 Q50,-10 70,20 Q100,0 90,50 Q110,80 80,80 Z" />
                    <path d="M20,80 Q25,50 35,60" fill="none" stroke="#22c55e" stroke-width="2" />
                    <path d="M70,80 Q65,40 55,50" fill="none" stroke="#22c55e" stroke-width="2" />
                </svg>
            `;
        }

        const MONSTER_TYPES = ['slime', 'mushroom', 'bat', 'ghost'];
        const COLORS = [
            { main: '#f87171', dark: '#991b1b' }, { main: '#fb923c', dark: '#9a3412' },
            { main: '#fbbf24', dark: '#92400e' }, { main: '#60a5fa', dark: '#1e40af' },
            { main: '#c084fc', dark: '#6b21a8' }, { main: '#f472b6', dark: '#9d174d' },
        ];

        async function init() {
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch(e) {}
                setupLeaderboard();
            }
            document.getElementById('start-button').onclick = startGame;
            document.getElementById('reset-button').onclick = resetGame;
            
            // ì´ˆê¸° ìŠ¤í…Œì´ì§€ ì„¤ì • ë¡œë“œ
            loadStageConfig(1);
            updateStatusDisplay();
        }

        // ìŠ¤í…Œì´ì§€ë³„ ì„¤ì •ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
        function getStageConfig(stage) {
            let config = {
                count: 10,
                speedBonus: 0,
                bushCount: 0
            };

            if (stage === 1) {
                config.count = 10;
                config.speedBonus = 0;
                config.bushCount = 0;
            } else if (stage === 2) {
                config.count = 10;
                config.speedBonus = 0.3; // 1ë‹¨ê³„ë³´ë‹¤ ì•½ê°„ ë¹ ë¥´ê²Œ
                config.bushCount = 0;
            } else if (stage === 3) {
                config.count = 15;
                config.speedBonus = 0.3; // 2ë‹¨ê³„ ì†ë„ ìœ ì§€
                config.bushCount = 3;
            } else if (stage === 4) {
                config.count = 20;
                config.speedBonus = 0.6; // 2ë‹¨ê³„(0.3)ë³´ë‹¤ ì¡°ê¸ˆ ë” ë¹ ë¥´ê²Œ
                config.bushCount = 3;
            } else if (stage === 5) {
                config.count = 25; // 5ëª… ì¶”ê°€
                config.speedBonus = 0.6;
                config.bushCount = 4; // í’€ìˆ² 1ê°œ ì¶”ê°€
            } else {
                // 6ë‹¨ê³„ ì´í›„: ê³„ì† ì–´ë ¤ì›Œì§
                config.count = 25 + (stage - 5) * 5;
                config.speedBonus = 0.8 + (stage - 5) * 0.2;
                config.bushCount = 4 + Math.floor((stage - 5) / 2);
            }
            return config;
        }

        function loadStageConfig(stage) {
            const config = getStageConfig(stage);
            currentStage = stage;
            totalMonstersInStage = config.count;
            currentTarget = 1;
            
            // UI ì—…ë°ì´íŠ¸ìš© í…ìŠ¤íŠ¸
            let info = `ğŸŒ± Stage ${stage}: ${config.count}ë§ˆë¦¬`;
            if(config.speedBonus > 0) info += ` (ì†ë„ UP!)`;
            if(config.bushCount > 0) info += ` (í’€ìˆ² ì£¼ì˜!)`;
            if(stageInfoText) stageInfoText.textContent = info;
        }

        function resetGame() {
            isGameRunning = false;
            clearInterval(timerInterval);
            cancelAnimationFrame(animId);
            const existingModal = document.getElementById('clear-modal');
            if (existingModal) existingModal.remove();
            startScreen.style.display = 'flex';
            timerDisplay.textContent = '0.000';
            
            // 1ë‹¨ê³„ë¡œ ë¦¬ì…‹
            loadStageConfig(1);
            
            updateStatusDisplay();
            gameArena.innerHTML = ''; 
            
            // í”ë“¤ë¦¼ íš¨ê³¼ ì œê±° (ë§Œì•½ ë‚¨ì•„ìˆë‹¤ë©´)
            gameArena.classList.remove('shake-screen');
        }

        function createBushes(count) {
            const w = gameArena.clientWidth;
            const h = gameArena.clientHeight;

            for(let i=0; i<count; i++) {
                const bush = document.createElement('div');
                bush.className = 'bush-obstacle';
                bush.innerHTML = getBushHTML();
                
                // ëœë¤ ìœ„ì¹˜ (í™”ë©´ ì¤‘ì•™ ìœ„ì£¼ë¡œ ë°°ì¹˜í•˜ì—¬ ê°€ë¦´ í™•ë¥  ë†’ì„)
                const bx = Math.random() * (w - 150) + 25;
                const by = Math.random() * (h - 150) + 25;
                
                bush.style.left = `${bx}px`;
                bush.style.top = `${by}px`;
                
                gameArena.appendChild(bush);
            }
        }

        function createMonsters() {
            gameArena.innerHTML = '';
            monsters = [];
            const w = gameArena.clientWidth;
            const h = gameArena.clientHeight;

            // í˜„ì¬ ìŠ¤í…Œì´ì§€ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const config = getStageConfig(currentStage);

            // í’€ìˆ² ìƒì„± (ëª¬ìŠ¤í„°ë³´ë‹¤ ë¨¼ì € ìƒì„±í•˜ì§€ë§Œ z-indexê°€ ë†’ì•„ì„œ ìœ„ì— ëœ¸)
            if (config.bushCount > 0) {
                createBushes(config.bushCount);
            }

            for(let i=1; i<=config.count; i++) {
                const el = document.createElement('div');
                el.className = 'monster-entity';
                el.dataset.number = i;
                const type = MONSTER_TYPES[i % 4];
                const colorSet = COLORS[i % COLORS.length];
                const startX = Math.random() * (w - 70);
                const startY = Math.random() * (h - 70);
                const angle = Math.random() * Math.PI * 2;
                
                // ì†ë„ ê³„ì‚°: ê¸°ë³¸ ë²”ìœ„ + ìŠ¤í…Œì´ì§€ ë³´ë„ˆìŠ¤
                const baseSpeed = SPEED_MIN_BASE + Math.random() * (SPEED_MAX_BASE - SPEED_MIN_BASE);
                const speed = baseSpeed + config.speedBonus;

                el.innerHTML = `${getMonsterHTML(type, colorSet.main, colorSet.dark)}<div class="number-badge">${i}</div>`;
                el.style.transform = `translate(${startX}px, ${startY}px)`;
                el.onmousedown = handleClick;
                el.ontouchstart = handleClick;
                gameArena.appendChild(el);

                monsters.push({ el, x: startX, y: startY, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, dead: false });
            }
        }

        function startGame() {
            startScreen.style.display = 'none';
            createMonsters();
            isGameRunning = true;
            startTime = performance.now();
            
            // íƒ€ì´ë¨¸ ì‹œì‘
            timerInterval = setInterval(() => {
                const t = (performance.now() - startTime) / 1000;
                timerDisplay.textContent = t.toFixed(3);
                
                // 100ì´ˆ íƒ€ì„ì•„ì›ƒ ì²´í¬
                if (t > TIMEOUT_LIMIT) {
                    handleTimeOut();
                }
            }, 10);
            
            if (!animId) loop();
        }
        
        function handleTimeOut() {
            isGameRunning = false;
            clearInterval(timerInterval);
            cancelAnimationFrame(animId);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur pointer-events-auto';
            modal.innerHTML = `
                <div class="start-panel">
                    <div class="text-7xl mb-4">â°</div>
                    <h2 class="text-3xl font-black text-red-500 mb-2">TIME OUT!</h2>
                    <p class="text-stone-600 mb-6 font-bold text-xl bg-white/80 p-2 rounded-lg">ì œí•œ ì‹œê°„ 100ì´ˆ ì´ˆê³¼!</p>
                    <button id="retry-btn" class="start-btn text-xl">TRY AGAIN</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            document.getElementById('retry-btn').onclick = () => {
                modal.remove();
                resetGame();
            };
        }

        function updateStatusDisplay() {
            stageDisplay.textContent = currentStage;
            currentTargetDisplay.textContent = currentTarget;
            totalMonstersDisplay.textContent = totalMonstersInStage;
        }

        function loop() {
            if(isGameRunning) {
                const w = gameArena.clientWidth;
                const h = gameArena.clientHeight;
                monsters.forEach(m => {
                    if(m.dead) return;
                    m.x += m.vx; m.y += m.vy;
                    if(m.x <= 0 || m.x >= w - 64) m.vx *= -1;
                    if(m.y <= 0 || m.y >= h - 64) m.vy *= -1;
                    m.el.style.transform = `translate(${m.x}px, ${m.y}px)`;
                    
                    // ëª¬ìŠ¤í„°ì˜ z-indexëŠ” Yì¢Œí‘œ ê¸°ì¤€ (ì•„ë˜ì— ìˆì„ìˆ˜ë¡ ì•ì— ë‚˜ì˜´)
                    // ë‹¨, í’€ìˆ²(z-index: 9990)ë³´ë‹¤ëŠ” í•­ìƒ ì•„ë˜ì— ê¹”ë¦¼
                    m.el.style.zIndex = Math.floor(m.y);
                    
                    const body = m.el.querySelector('.monster-body');
                    if(m.vx > 0) body.style.transform = 'scaleX(-1)'; 
                    else body.style.transform = 'scaleX(1)'; 
                });
            }
            animId = requestAnimationFrame(loop);
        }

        function handleClick(e) {
            e.preventDefault();
            if(!isGameRunning) return;
            const el = e.currentTarget;
            const num = parseInt(el.dataset.number);
            const m = monsters.find(obj => obj.el === el);
            if(m.dead) return;

            if(num === currentTarget) {
                m.dead = true;
                el.classList.add('dead');
                currentTarget++;
                if(currentTarget > totalMonstersInStage) handleStageClear();
                else updateStatusDisplay();
            } else {
                // ì˜¤ë‹µ ì²˜ë¦¬: í™”ë©´ í”ë“¤ë¦¼ íš¨ê³¼
                gameArena.classList.remove('shake-screen'); // ì¬ì‹¤í–‰ì„ ìœ„í•´ ì œê±°
                void gameArena.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ (ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹)
                gameArena.classList.add('shake-screen');
                
                // ëª¬ìŠ¤í„° ì‹œê° íš¨ê³¼
                el.style.filter = 'brightness(2) saturate(2) hue-rotate(90deg)';
                setTimeout(() => el.style.filter = '', 150);
                
                // í”ë“¤ë¦¼ í´ë˜ìŠ¤ ì œê±° íƒ€ì´ë¨¸ (ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ í›„)
                setTimeout(() => {
                    gameArena.classList.remove('shake-screen');
                }, 400);
            }
        }

        async function handleStageClear() {
            isGameRunning = false;
            clearInterval(timerInterval);
            const score = timerDisplay.textContent;
            if(db) await addDoc(collection(db, COLLECTION_PATH), { stage: currentStage, time: parseFloat(score), timestamp: serverTimestamp() });

            // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì •ë³´ ë¯¸ë¦¬ ê³„ì‚°
            const nextStageConfig = getStageConfig(currentStage + 1);
            let nextInfo = `${nextStageConfig.count}ë§ˆë¦¬`;
            if(nextStageConfig.bushCount > 0) nextInfo += `, í’€ìˆ² ${nextStageConfig.bushCount}ê°œ`;
            if(nextStageConfig.speedBonus > 0) nextInfo += `, ì†ë„ UP!`;

            const modal = document.createElement('div');
            modal.id = 'clear-modal';
            modal.className = 'fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur pointer-events-auto';
            modal.innerHTML = `
                <div class="start-panel">
                    <div class="text-7xl mb-4">ğŸ‰</div>
                    <h2 class="text-3xl font-black text-white mb-2">STAGE ${currentStage} CLEAR</h2>
                    <p class="text-stone-300 mb-6 font-bold">ê¸°ë¡: <span class="text-green-400 font-mono text-3xl font-black">${score}s</span></p>
                    
                    <div class="bg-white/20 p-4 rounded-xl mb-6">
                        <p class="text-white text-sm font-bold mb-1">NEXT: STAGE ${currentStage + 1}</p>
                        <p class="text-yellow-300 text-xs">${nextInfo}</p>
                    </div>

                    <button id="next-stage-btn" class="start-btn text-xl">NEXT STAGE</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('next-stage-btn').onclick = () => {
                modal.remove();
                
                // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì„¤ì • ë¡œë“œ
                loadStageConfig(currentStage + 1);
                
                updateStatusDisplay();
                startGame();
            };
        }

        function setupLeaderboard() {
            if(!db) return;
            onSnapshot(collection(db, COLLECTION_PATH), snap => {
                const list = [];
                snap.forEach(d => list.push(d.data()));
                list.sort((a,b) => b.stage !== a.stage ? b.stage - a.stage : a.time - b.time);
                leaderboardEl.innerHTML = list.slice(0,5).map((s, i) => `
                    <li class="flex justify-between items-center p-2 bg-white/10 rounded-lg mb-1">
                        <span class="${i<3 ? 'text-yellow-400 font-bold' : 'text-stone-300'}">${i+1}. LV.${s.stage}</span>
                        <span class="font-mono font-bold text-green-300">${s.time.toFixed(2)}s</span>
                    </li>
                `).join('') || '<li class="text-center text-stone-400 text-xs py-2 italic">ê¸°ë¡ ì—†ìŒ</li>';
            });
        }

        init();
    </script>
</body>
</html>
