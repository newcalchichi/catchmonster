<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î™¨Ïä§ÌÑ∞ Îü¨Ïâ¨: Ìåú Ïä§ÌÖåÏù¥ÏßÄ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        /* Í∏∞Î≥∏ ÏÑ§Ï†ï */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Jua', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            background-color: #1c1917;
            margin: 0;
            padding: 0;
        }
        
        /* ÌôîÎ©¥ ÌùîÎì§Î¶º Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-screen { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        
        /* Î™¨Ïä§ÌÑ∞ ÏÇ¨Îßù Ïù¥ÌéôÌä∏ */
        @keyframes pop-kill {
            0% { transform: var(--monster-transform, translate(0, 0)) scale(1); opacity: 1; }
            50% { transform: var(--monster-transform, translate(0, 0)) scale(1.4); opacity: 0.8; }
            100% { transform: var(--monster-transform, translate(0, 0)) scale(0); opacity: 0; }
        }
        .dying {
            animation: pop-kill 0.15s ease-out forwards;
            pointer-events: none;
        }

        /* Î∂àÎπõ ÌûåÌä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes hint-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .hint-active {
            animation: hint-pulse 1s infinite;
            z-index: 9999 !important;
            filter: brightness(1.5) !important;
        }

        /* ÏÉÅÎã® HUD Î∞î */
        .hud-bar {
            height: 100px;
            background: #1c1917;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            pointer-events: auto;
            border-bottom: 6px solid #44403c;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 100;
            position: relative;
            flex-shrink: 0;
        }
        @media (min-width: 768px) { .hud-bar { gap: 40px; } }

        #game-arena {
            position: absolute;
            top: 100px;
            left: 0;
            width: 100vw;
            height: calc(100dvh - 100px); 
            background-color: #4ade80;
            background-image: url('https://raw.githubusercontent.com/chalchichi/testresource/main/Gemini_Generated_Image_p0oedlp0oedlp0oe.png'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            cursor: crosshair;
            z-index: 0;
            overflow: hidden;
        }

        /* Ïö∏ÌÉÄÎ¶¨ Ïä§ÌÉÄÏùº */
        .fence-line {
            position: absolute;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHBhdGggZD0iTTAgMEwyMCAyME0yMCAwTDAgMjAiIHN0cm9rZT0iIzVkNDAzNyIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+');
            background-color: #795548;
            border: 2px solid #3e2723;
            z-index: 50;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .fence-horizontal {
            top: 50%; left: 0; width: 100%; height: 16px;
            transform: translateY(-50%);
        }

        .hud-item { display: flex; flex-direction: column; align-items: center; }
        .hud-label { font-size: 0.8rem; color: #d6d3d1; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
        @media (min-width: 768px) { .hud-label { font-size: 1rem; } }
        .hud-value { font-family: 'Jua', sans-serif; font-size: 1.5rem; line-height: 1; }
        @media (min-width: 768px) { .hud-value { font-size: 2rem; } }

        #timer {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
            min-width: 80px;
            text-align: center;
        }
        @media (min-width: 768px) { #timer { min-width: 120px; } }

        .monster-entity {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            cursor: pointer;
            will-change: transform;
            transition: opacity 0.2s, transform 0.1s;
        }
        @media (min-width: 768px) {
            .monster-entity { width: 64px; height: 64px; }
        }

        .giant-monster {
            width: 200px !important;
            height: 200px !important;
            z-index: 9999;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.6));
        }

        /* Î≥¥Ïä§ Î™¨Ïä§ÌÑ∞ Ïä§ÌÉÄÏùº */
        .boss-monster {
            width: 120px !important;
            height: 120px !important;
            z-index: 9998;
            filter: drop-shadow(0 8px 8px rgba(255, 0, 0, 0.8));
            border: 3px solid #ff0000;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
        }
        @media (min-width: 768px) {
            .boss-monster {
                width: 150px !important;
                height: 150px !important;
            }
        }
        
        /* Î≥¥Ïä§ HP ÌëúÏãú */
        .boss-hp {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, #ff0000, #cc0000);
            color: white;
            font-weight: 900;
            font-size: 0.9rem;
            min-width: 40px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 100;
            line-height: 1;
            padding: 0 8px;
        }
        @media (min-width: 768px) {
            .boss-hp {
                font-size: 1.1rem;
                min-width: 50px;
                height: 28px;
                top: -18px;
            }
        }

        /* Î™¨Ïä§ÌÑ∞ ÏÉâÏÉÅ Ïä§ÌÉÄÏùº */
        .monster-body {
            width: 100%;
            height: 100%;
        }
        
        .monster-body .slime-body {
            fill: var(--monster-color, #f87171);
        }
        
        .monster-body .mushroom-cap {
            fill: var(--monster-color, #f87171);
        }
        
        .monster-body .mushroom-stem {
            fill: #fef3c7;
        }
        
        .monster-body .bat-body {
            fill: var(--monster-color, #f87171);
        }
        
        .monster-body .bat-wing {
            fill: var(--monster-dark-color, #991b1b);
        }
        
        .monster-body .ghost-body {
            fill: var(--monster-color, #f87171);
        }
        
        .monster-body .eye {
            fill: white;
        }
        
        .monster-body .pupil {
            fill: black;
        }

        /* Ïà´Ïûê Î∞∞ÏßÄ Ïä§ÌÉÄÏùº */
        .number-badge {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, #ffffff, #f0f0f0);
            color: #1c1917;
            font-weight: 900;
            font-size: 0.9rem;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            border: 3px solid #fbbf24;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5), 0 0 0 1px rgba(251, 191, 36, 0.3);
            z-index: 100;
            line-height: 1;
            padding: 0 6px;
            text-shadow: none;
        }
        @media (min-width: 768px) {
            .number-badge {
                font-size: 1.1rem;
                min-width: 28px;
                height: 28px;
                top: -10px;
                border-width: 4px;
            }
        }

        .bush-obstacle {
            position: absolute;
            width: 120px;
            height: 100px;
            pointer-events: none;
            z-index: 9990;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }
        .bush-svg { width: 100%; height: 100%; fill: #15803d; stroke: #052e16; stroke-width: 3px; }

        /* Î≥¥Î¨º ÏÉÅÏûê Ïä§ÌÉÄÏùº */
        .treasure-chest {
            position: absolute;
            width: 80px;
            height: 80px;
            cursor: pointer;
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: treasurePulse 1s ease-in-out infinite;
            filter: drop-shadow(0 5px 10px rgba(255, 215, 0, 0.6));
        }
        @media (min-width: 768px) {
            .treasure-chest { width: 100px; height: 100px; }
        }
        @keyframes treasurePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .treasure-chest svg {
            width: 100%;
            height: 100%;
        }
        
        /* Î≥¥Î¨º ÏÉÅÏûê ÏàòÏßë ÌÖçÏä§Ìä∏ */
        .treasure-text {
            position: absolute;
            color: #FFD700;
            font-size: 1.5rem;
            font-weight: 900;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(255, 215, 0, 0.8);
            pointer-events: none;
            z-index: 10000;
            animation: treasureTextFloat 1s ease-out forwards;
        }
        @media (min-width: 768px) {
            .treasure-text { font-size: 2rem; }
        }
        @keyframes treasureTextFloat {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translateY(-80px) scale(1.2);
                opacity: 0;
            }
        }

        /* ÌÉÄÍ≤© Ïù¥ÌéôÌä∏ */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
        }

        /* Î™®Îã¨ Î∞è ÌôîÎ©¥ Í≥µÌÜµ */
        #start-screen, #stats-modal {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px); z-index: 200;
            display: flex; align-items: center; justify-content: center;
            padding: 0; height: 100dvh;
            overflow: hidden;
        }

        #stats-modal { z-index: 300; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); padding: 20px; }

        /* ÏùºÎ∞ò ÌåùÏóÖ Ìå®ÎÑê */
        .start-panel {
            background-color: #292524;
            border: 6px solid #44403c; 
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            padding: 30px 20px; max-width: 600px; width: 100%;
            max-height: 85dvh; overflow-y: auto;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }

        /* ÏãúÏûë ÌôîÎ©¥ Ï†ÑÏö© Ïä§ÌÉÄÏùº (Ï†ÑÏ≤¥ Î∞∞Í≤Ω) */
        .start-panel.home {
            background-image: url('https://raw.githubusercontent.com/chalchichi/testresource/main/%E1%84%87%E1%85%A2%E1%84%80%E1%85%A7%E1%86%BC.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #292524; /* Î°úÎî© Ï†Ñ Î∞∞Í≤ΩÏÉâ */
            
            border: none;
            border-radius: 0;
            width: 100vw;
            height: 100dvh;
            max-width: none;
            max-height: none;
            padding: 0;
            
            justify-content: flex-end; /* Î≤ÑÌäº ÌïòÎã® Î∞∞Ïπò */
            padding-bottom: 20vh; /* ÌïòÎã®ÏóêÏÑú 20% ÎÜíÏù¥ÎßåÌÅº ÎùÑÏõÄ (ÏÇ¨Îûå Í∞ÄÎ¶º Î∞©ÏßÄ) */
        }
        @media (max-width: 768px) {
            .start-panel.home {
                background-image: url('https://raw.githubusercontent.com/chalchichi/testresource/main/%E1%84%86%E1%85%A9%E1%84%87%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%AF_%E1%84%87%E1%85%A2%E1%84%80%E1%85%A7%E1%86%BC.jpg');
                padding-bottom: 10vh; /* Î™®Î∞îÏùºÏóêÏÑú Îçî ÏúÑÎ°ú Ïò¨Î†§ÏÑú ÎßùÏπò Îì±Ïù¥ Ïïà Í∞ÄÎ¶¨ÎèÑÎ°ù */
            }
        }

        /* Ïù¥ÎØ∏ÏßÄ Î≤ÑÌäº Ïä§ÌÉÄÏùº (ÏãúÏûë Î≤ÑÌäº) */
        .image-btn-container {
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
            z-index: 20;
            display: block;
            width: 70%; /* Î™®Î∞îÏùº ÎÑàÎπÑ */
            max-width: 350px;
        }
        @media (max-width: 768px) {
            .image-btn-container {
                width: 50%; /* Î™®Î∞îÏùºÏóêÏÑú Îçî ÏûëÍ≤å */
                max-width: 250px;
            }
        }
        .image-btn-container:hover { transform: scale(1.05); }
        .image-btn-container:active { transform: scale(0.95); }
        
        .image-btn-img {
            width: 100%;
            height: auto;
            display: block;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); /* Î≤ÑÌäº Í∑∏Î¶ºÏûê Ï∂îÍ∞Ä */
        }

        /* ÏùºÎ∞ò ÌÖçÏä§Ìä∏ Î≤ÑÌäº */
        .start-btn {
            background: linear-gradient(to bottom, #4ade80, #16a34a);
            color: white; font-size: 1.8rem; padding: 12px 30px;
            border-radius: 20px; box-shadow: 0 6px 0 #14532d, 0 10px 10px rgba(0,0,0,0.2);
            transition: all 0.1s; display: inline-block; width: 100%;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1); position: relative;
            z-index: 10; border: 2px solid #ffffff; flex-shrink: 0;
        }
        @media (min-width: 768px) { .start-btn { font-size: 2.2rem; padding: 15px 40px; } }
        .start-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #14532d; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #5d4037; border-radius: 10px; }

        /* Benefit Cards Styles */
        .benefit-container {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%; margin-bottom: 20px;
        }
        @media (max-width: 600px) {
            .benefit-container { grid-template-columns: 1fr; gap: 8px; }
            .benefit-container.many-items { grid-template-columns: repeat(2, 1fr); }
        }
        
        .benefit-card {
            background: linear-gradient(to bottom, #ffffff, #f3f4f6);
            border: 4px solid #e5e7eb; border-radius: 16px; padding: 10px;
            cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 120px; position: relative; overflow: hidden;
        }
        .benefit-card:hover { transform: translateY(-5px); filter: brightness(1.05); }
        .benefit-card:active { transform: scale(0.95); }
        .benefit-card.selected { border-color: #22c55e; background: #dcfce7; opacity: 0.5; pointer-events: none; }
        
        .rarity-normal { border-color: #9ca3af; box-shadow: 0 4px 0 #6b7280; }
        .rarity-normal .card-title { color: #4b5563; }
        .rarity-rare { border-color: #3b82f6; box-shadow: 0 4px 0 #1d4ed8; }
        .rarity-rare .card-title { color: #2563eb; }
        .rarity-rare::before { content: "RARE"; position: absolute; top: 0; right: 0; background: #3b82f6; color: white; font-size: 0.6rem; padding: 2px 6px; border-bottom-left-radius: 8px; }
        .rarity-legend { border-color: #eab308; box-shadow: 0 4px 0 #a16207; background: linear-gradient(to bottom, #fffbeb, #fef3c7); }
        .rarity-legend .card-title { color: #ca8a04; text-shadow: 0 1px 0 rgba(0,0,0,0.1); }
        .rarity-legend::before { content: "LEGEND"; position: absolute; top: 0; right: 0; background: #eab308; color: black; font-size: 0.6rem; padding: 2px 6px; border-bottom-left-radius: 8px; font-weight: bold; }

        .card-icon { font-size: 1.8rem; margin-bottom: 4px; }
        .card-title { font-weight: 900; font-size: 0.95rem; margin-bottom: 4px; line-height: 1.1; }
        .card-desc { font-size: 0.75rem; color: #6b7280; line-height: 1.2; word-break: keep-all; }

        /* Active Benefits HUD */
        #active-benefits {
            position: fixed; top: 110px; left: 10px;
            display: flex; flex-direction: column; gap: 4px;
            z-index: 90; pointer-events: none; align-items: flex-start;
        }
        .active-benefit-item {
            background: rgba(0,0,0,0.5); color: white; padding: 2px 8px;
            border-radius: 12px; font-size: 0.8rem; font-weight: bold;
            display: flex; align-items: center; gap: 4px;
            backdrop-filter: blur(2px); border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
        }
        
        .stats-list { width: 100%; text-align: left; background: rgba(0,0,0,0.4); border-radius: 12px; padding: 10px; }
        .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); color: #d6d3d1; }
        .stat-item:last-child { border-bottom: none; }
        .stat-val { font-weight: bold; color: #4ade80; }

        #bonus-layer { position: fixed; inset: 0; z-index: 150; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); }

    </style>
</head>
<body>

    <div class="hud-bar">
        <!-- Ïä§ÌÉØ Î≥¥Í∏∞ Î≤ÑÌäº -->
        <button id="stats-btn" class="absolute left-2 md:left-8 bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 text-sm md:px-4 md:py-3 md:text-xl rounded-2xl border-b-4 border-blue-800 transition-all active:border-b-0 active:translate-y-1 font-bold">
            üìä Ïä§ÌÉØ
        </button>

        <div class="hud-item">
            <span class="hud-label">STAGE</span>
            <span class="hud-value text-yellow-400" id="stage-display">1</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">TARGET</span>
            <div class="hud-value text-white bg-stone-800 px-3 py-1 md:px-4 md:py-1 rounded-xl border-2 border-stone-600">
                <span id="current-target">1</span>
                <span class="text-base md:text-xl text-stone-500 font-normal">/ <span id="total-monsters-display">10</span></span>
            </div>
        </div>
        <div class="hud-item ml-2 md:ml-10">
            <span class="hud-label">TIME</span>
            <span class="hud-value text-green-400" id="timer">0.000</span>
        </div>
        
        <!-- Ï¢ÖÎ£å Î≤ÑÌäº -->
        <button id="reset-button" class="absolute right-2 md:right-8 bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 text-sm md:px-4 md:py-3 md:text-xl rounded-2xl border-b-4 border-red-800 transition-all active:border-b-0 active:translate-y-1 font-bold">
            ‚ùå Ï¢ÖÎ£å
        </button>
    </div>

    <div id="game-arena"></div>
    <div id="bonus-layer"></div>

    <!-- Stats Modal -->
    <div id="stats-modal" style="display: none;">
        <div class="start-panel" style="background-image: none; background-color: #292524;">
            <h2 class="text-3xl font-black text-white mb-4">ÌòÑÏû¨ Ïä§ÌÉØ ÌòÑÌô©</h2>
            <div class="stats-list" id="stats-list-content">
                <!-- JSÎ°ú Ï±ÑÏõåÏßê -->
            </div>
            <button id="close-stats-btn" class="start-btn mt-6">Îã´Í∏∞</button>
        </div>
    </div>

    <div id="start-screen">
        <div class="start-panel home">
            <!-- Ïù¥ÎØ∏ÏßÄ ÏãúÏûë Î≤ÑÌäº -->
            <div id="start-button" class="image-btn-container">
                <img src="https://raw.githubusercontent.com/chalchichi/testresource/main/image.png" alt="Game Start" class="image-btn-img">
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const SPEED_MIN_BASE = 0.3;
        const SPEED_MAX_BASE = 0.8;
        const DEFAULT_TIMEOUT_LIMIT = 30.0;

        const gameArena = document.getElementById('game-arena');
        const bonusLayer = document.getElementById('bonus-layer');
        const currentTargetDisplay = document.getElementById('current-target');
        const totalMonstersDisplay = document.getElementById('total-monsters-display');
        const stageDisplay = document.getElementById('stage-display');
        const timerDisplay = document.getElementById('timer');
        const startScreen = document.getElementById('start-screen');
        const statsModal = document.getElementById('stats-modal');
        const statsListContent = document.getElementById('stats-list-content');
        const activeBenefitsEl = document.getElementById('active-benefits');
        
        let currentStage = 1;
        let totalMonstersInStage = 10;
        let currentTarget = 1;
        let isGameRunning = false;
        let startTime = 0;
        let timerInterval = null;
        let animId = null;
        let monsters = [];
        let hintTimer = null;
        let treasureChestTimer = null;
        let treasureChestElement = null;
        let bossMonster = null; 

        // Benefit State
        let activeBenefits = {
            initialKill: 0,
            slowPercent: 0,
            timeExtension: 0,
            bushRemoval: 0,
            fenceLevel: 0,
            lightLevel: 0,
            extraOptions: 0 
        };

        let app, db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const COLLECTION_PATH = `/artifacts/${appId}/public/data/leaderboard_cute_stage`;

        const BENEFIT_TYPES = {
            KILL: 'kill',
            SLOW: 'slow',
            TIME: 'time',
            REMOVE_BUSH: 'remove_bush',
            FENCE: 'fence',
            LIGHT: 'light',
            EXTRA_OPTION: 'extra_option'
        };

        function getMonsterHTML(type, color, darkColor) {
            const eyes = `<circle class="eye" cx="24" cy="28" r="6" /><circle class="pupil" cx="24" cy="28" r="2.5" /><circle class="eye" cx="40" cy="28" r="6" /><circle class="pupil" cx="40" cy="28" r="2.5" />`;
            if (type === 'slime') return `<div class="monster-body slime-anim" style="--monster-color: ${color}"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="slime-body" d="M10,45 Q10,15 32,15 Q54,15 54,45 Q54,58 50,60 Q32,64 14,60 Q10,58 10,45 Z" />${eyes}</svg></div>`;
            if (type === 'mushroom') return `<div class="monster-body mushroom-anim" style="--monster-color: ${color}"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="mushroom-stem" d="M22,60 L22,35 L42,35 L42,60 Q32,64 22,60 Z" /><path class="mushroom-cap" d="M6,35 Q32,0 58,35 Z" />${eyes}</svg></div>`;
            if (type === 'bat') return `<div class="monster-body bat-anim" style="--monster-color: ${color}; --monster-dark-color: ${darkColor}"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="bat-wing" d="M10,30 Q-5,10 20,25 L20,35 Z" /><path class="bat-wing" d="M54,30 Q69,10 44,25 L44,35 Z" /><ellipse class="bat-body" cx="32" cy="35" rx="14" ry="16" />${eyes}</svg></div>`;
            return `<div class="monster-body ghost-anim" style="--monster-color: ${color}"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="ghost-body" d="M12,60 L12,30 Q12,10 32,10 Q52,10 52,30 L52,60 L42,50 L32,60 L22,50 L12,60 Z" />${eyes}</svg></div>`;
        }

        function getBushHTML() {
            return `<svg class="bush-svg" viewBox="0 0 100 80"><path d="M10,80 Q-10,40 20,30 Q10,10 40,15 Q50,-10 70,20 Q100,0 90,50 Q110,80 80,80 Z" /><path d="M20,80 Q25,50 35,60" fill="none" stroke="#22c55e" stroke-width="2" /><path d="M70,80 Q65,40 55,50" fill="none" stroke="#22c55e" stroke-width="2" /></svg>`;
        }

        const MONSTER_TYPES = ['slime', 'mushroom', 'bat', 'ghost'];
        const COLORS = [{ main: '#f87171', dark: '#991b1b' }, { main: '#fb923c', dark: '#9a3412' }, { main: '#fbbf24', dark: '#92400e' }, { main: '#60a5fa', dark: '#1e40af' }, { main: '#c084fc', dark: '#6b21a8' }, { main: '#f472b6', dark: '#9d174d' }];

        async function init() {
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch(e) {}
                setupLeaderboard();
            }
            document.getElementById('start-button').onclick = startGame;
            document.getElementById('reset-button').onclick = resetGame;
            document.getElementById('stats-btn').onclick = toggleStats;
            document.getElementById('close-stats-btn').onclick = toggleStats;
            
            loadStageConfig(1);
            updateStatusDisplay();
        }

        // Î™¨Ïä§ÌÑ∞ ÌÅ¨Í∏∞ ÎèôÏ†Å Í≥ÑÏÇ∞
        function getMonsterSize() {
            return window.innerWidth < 768 ? 48 : 64;
        }

        function getStageConfig(stage) {
            let config = { count: 10, speedBonus: 0, bushCount: 0 };
            
            if (stage === 1) { config.count = 10; config.speedBonus = 0; config.bushCount = 0; }
            else if (stage === 2) { config.count = 10; config.speedBonus = 0.3; config.bushCount = 0; }
            else if (stage === 3) { config.count = 15; config.speedBonus = 0.3; config.bushCount = 1; }
            else if (stage === 4) { config.count = 20; config.speedBonus = 0.6; config.bushCount = 1; }
            else if (stage === 5) { config.count = 25; config.speedBonus = 0.6; config.bushCount = 2; }
            else if (stage === 6) { config.count = 30; config.speedBonus = 0.6; config.bushCount = 2; }
            else if (stage === 7) { config.count = 30; config.speedBonus = 0.7; config.bushCount = 2; }
            else if (stage === 8) { config.count = 35; config.speedBonus = 0.7; config.bushCount = 3; }
            else if (stage === 9) { config.count = 40; config.speedBonus = 0.7; config.bushCount = 3; }
            else if (stage === 10) { config.count = 40; config.speedBonus = 0.7; config.bushCount = 4; }
            else {
                config.count = 40 + (stage - 10) * 5;
                config.speedBonus = 0.8 + (stage - 10) * 0.1;
                config.bushCount = 4 + Math.floor((stage - 10) / 2);
            }
            return config;
        }

        function loadStageConfig(stage) {
            const config = getStageConfig(stage);
            currentStage = stage;
            totalMonstersInStage = config.count;
            currentTarget = 1;
        }

        function resetGame() {
            isGameRunning = false;
            clearInterval(timerInterval);
            if (animId) { cancelAnimationFrame(animId); animId = null; }
            if (hintTimer) { clearTimeout(hintTimer); hintTimer = null; }
            if (treasureChestTimer) { clearTimeout(treasureChestTimer); treasureChestTimer = null; }
            removeTreasureChest();
            bossMonster = null;
            
            document.querySelectorAll('.fixed.z-\\[200\\]').forEach(el => el.remove());
            bonusLayer.style.display = 'none';
            bonusLayer.innerHTML = '';
            statsModal.style.display = 'none';

            startScreen.style.display = 'flex';
            timerDisplay.textContent = '0.000';
            
            activeBenefits = { initialKill: 0, slowPercent: 0, timeExtension: 0, bushRemoval: 0, fenceLevel: 0, lightLevel: 0, extraOptions: 0 };
            
            loadStageConfig(1);
            updateStatusDisplay();
            gameArena.innerHTML = ''; 
            gameArena.classList.remove('shake-screen');
        }

        function createBushes(count) {
            const finalCount = Math.max(0, count - activeBenefits.bushRemoval);
            const w = gameArena.clientWidth;
            const h = gameArena.clientHeight;
            for(let i=0; i<finalCount; i++) {
                const bush = document.createElement('div');
                bush.className = 'bush-obstacle';
                bush.innerHTML = getBushHTML();
                const bx = Math.random() * (w - 150) + 25;
                const by = Math.random() * (h - 150) + 25;
                bush.style.left = `${bx}px`;
                bush.style.top = `${by}px`;
                gameArena.appendChild(bush);
            }
        }

        function createMonsters() {
            gameArena.innerHTML = '';
            monsters = [];
            
            if (activeBenefits.fenceLevel >= 1) {
                const hFence = document.createElement('div');
                hFence.className = 'fence-line fence-horizontal';
                gameArena.appendChild(hFence);
            }

            const w = gameArena.clientWidth;
            const h = gameArena.clientHeight;
            const config = getStageConfig(currentStage);
            const monsterSize = getMonsterSize();

            if (config.bushCount > 0) createBushes(config.bushCount);

            for(let i=1; i<=config.count; i++) {
                const el = document.createElement('div');
                el.className = 'monster-entity';
                el.dataset.number = i;
                const type = MONSTER_TYPES[i % 4];
                const colorSet = COLORS[i % COLORS.length];
                
                let bounds = { minX: 0, maxX: w, minY: 0, maxY: h };

                if (activeBenefits.fenceLevel >= 1) {
                    if (i <= config.count / 2) {
                        bounds.maxY = h / 2;
                    } else {
                        bounds.minY = h / 2;
                    }
                }

                const padding = 10;
                const safeMaxX = bounds.maxX - monsterSize - padding;
                const safeMaxY = bounds.maxY - monsterSize - padding;
                const safeMinX = bounds.minX + padding;
                const safeMinY = bounds.minY + padding;

                const startX = safeMinX + Math.random() * (safeMaxX - safeMinX);
                const startY = safeMinY + Math.random() * (safeMaxY - safeMinY);

                const angle = Math.random() * Math.PI * 2;
                
                let baseSpeed = SPEED_MIN_BASE + Math.random() * (SPEED_MAX_BASE - SPEED_MIN_BASE);
                let speed = (baseSpeed + config.speedBonus) * (1 - (activeBenefits.slowPercent / 100));
                if (speed < 0.1) speed = 0.1;

                el.innerHTML = `${getMonsterHTML(type, colorSet.main, colorSet.dark)}<div class="number-badge">${i}</div>`;
                el.style.transform = `translate(${startX}px, ${startY}px)`;
                el.onmousedown = handleClick;
                el.ontouchstart = handleClick;
                gameArena.appendChild(el);

                const isDeadStart = i <= activeBenefits.initialKill;
                if (isDeadStart) {
                    el.classList.add('dead');
                    el.style.opacity = '0.3';
                    el.style.pointerEvents = 'none';
                }

                monsters.push({ 
                    el, x: startX, y: startY, 
                    vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, 
                    dead: isDeadStart,
                    id: i,
                    bounds: bounds,
                    color: colorSet.main
                });
            }

            // Î≥¥Ïä§ ÏÉùÏÑ± (7Îã®Í≥Ñ)
            if (currentStage === 7) {
                createBoss();
            }

            if (activeBenefits.initialKill > 0) {
                currentTarget = 1 + activeBenefits.initialKill;
                if (currentTarget > totalMonstersInStage) {
                    // Î≥¥Ïä§Í∞Ä ÏûàÏúºÎ©¥ Î≥¥Ïä§Î•º Ïû°Í∏∞ Ï†ÑÍπåÏßÄ Ïä§ÌÖåÏù¥ÏßÄ ÌÅ¥Î¶¨Ïñ¥ ÏïàÎê®
                    if (!bossMonster || bossMonster.hp <= 0) {
                        setTimeout(handleStageClear, 500);
                    }
                }
            }
            updateStatusDisplay();
            resetHintTimer(); 
        }
        
        function createBoss() {
            if (bossMonster) return; // Ïù¥ÎØ∏ Î≥¥Ïä§Í∞Ä ÏûàÏúºÎ©¥ ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏùå
            
            const w = gameArena.clientWidth;
            const h = gameArena.clientHeight;
            const bossSize = window.innerWidth < 768 ? 120 : 150;
            
            // ÎûúÎç§ÌïòÍ≤å ÏùºÎ∞ò Î™¨Ïä§ÌÑ∞ ÌÉÄÏûÖ ÏÑ†ÌÉù
            const randomType = MONSTER_TYPES[Math.floor(Math.random() * MONSTER_TYPES.length)];
            const randomColorSet = COLORS[Math.floor(Math.random() * COLORS.length)];
            
            const el = document.createElement('div');
            el.className = 'monster-entity boss-monster';
            el.dataset.isBoss = 'true';
            el.dataset.bossHp = '20';
            
            const startX = Math.random() * (w - bossSize - 20) + 10;
            const startY = Math.random() * (h - bossSize - 20) + 10;
            
            el.innerHTML = `${getMonsterHTML(randomType, randomColorSet.main, randomColorSet.dark)}<div class="boss-hp">20</div>`;
            el.style.transform = `translate(${startX}px, ${startY}px)`;
            el.onmousedown = handleBossClick;
            el.ontouchstart = handleBossClick;
            gameArena.appendChild(el);
            
            const angle = Math.random() * Math.PI * 2;
            let baseSpeed = SPEED_MIN_BASE + Math.random() * (SPEED_MAX_BASE - SPEED_MIN_BASE);
            let speed = baseSpeed * 0.5; // Î≥¥Ïä§Îäî Ï°∞Í∏à ÎäêÎ¶¨Í≤å
            
            bossMonster = {
                el: el,
                x: startX,
                y: startY,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                hp: 20,
                bounds: { minX: 0, maxX: w, minY: 0, maxY: h },
                color: randomColorSet.main,
                size: bossSize
            };
        }
        
        function handleBossClick(e) {
            e.preventDefault();
            e.stopPropagation();
            if(!isGameRunning || !bossMonster) return;
            
            bossMonster.hp--;
            const hpEl = bossMonster.el.querySelector('.boss-hp');
            if (hpEl) {
                hpEl.textContent = bossMonster.hp;
            }
            
            // Î≥¥Ïä§ HPÍ∞Ä 0Ïù¥ ÎêòÎ©¥ Ï£ΩÏùå
            if (bossMonster.hp <= 0) {
                bossMonster.el.classList.add('dying');
                bossMonster.el.classList.remove('hint-active');
                
                // ÌòÑÏû¨ transform Í∞íÏùÑ CSS Î≥ÄÏàòÎ°ú Ï†ÄÏû•
                const currentTransform = bossMonster.el.style.transform || `translate(${bossMonster.x}px, ${bossMonster.y}px)`;
                bossMonster.el.style.setProperty('--monster-transform', currentTransform);
                
                // Î≥¥Ïä§ Ï†úÍ±∞
                setTimeout(() => {
                    if (bossMonster && bossMonster.el) {
                        bossMonster.el.remove();
                    }
                    bossMonster = null;
                    
                    // Î≥¥Ïä§Î•º Ïû°ÏúºÎ©¥ Ïä§ÌÖåÏù¥ÏßÄ ÌÅ¥Î¶¨Ïñ¥
                    if (currentTarget > totalMonstersInStage) {
                        handleStageClear();
                    }
                }, 150);
            } else {
                // ÌîºÍ≤© Ìö®Í≥º (ÍπúÎπ°ÏûÑ)
                bossMonster.el.style.filter = 'drop-shadow(0 8px 8px rgba(255, 255, 0, 1))';
                setTimeout(() => {
                    if (bossMonster && bossMonster.el) {
                        bossMonster.el.style.filter = 'drop-shadow(0 8px 8px rgba(255, 0, 0, 0.8))';
                    }
                }, 100);
            }
        }

        function createExplosion(x, y, color) {
            // ÌååÌã∞ÌÅ¥ ÌÅ¨Í∏∞(8px)Ïùò Ï†àÎ∞òÏùÑ ÎπºÏÑú Ï§ëÏã¨Ï†ê ÎßûÏ∂îÍ∏∞
            const particleSize = 8;
            const offsetX = x - particleSize / 2;
            const offsetY = y - particleSize / 2;
            
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.backgroundColor = color;
                p.style.position = 'absolute';
                p.style.left = offsetX + 'px';
                p.style.top = offsetY + 'px';
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 3 + Math.random() * 6;
                const tx = Math.cos(angle) * velocity * 30; 
                const ty = Math.sin(angle) * velocity * 30;

                gameArena.appendChild(p);

                const animation = p.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 500,
                    easing: 'cubic-bezier(0, .9, .57, 1)'
                });

                animation.onfinish = () => p.remove();
            }
        }

        function resetHintTimer() {
            if (hintTimer) clearTimeout(hintTimer);
            document.querySelectorAll('.hint-active').forEach(el => el.classList.remove('hint-active'));
            if (activeBenefits.lightLevel > 0 && isGameRunning) {
                let delay = 2000;
                if (activeBenefits.lightLevel === 2) delay = 1500;
                if (activeBenefits.lightLevel >= 3) delay = 1000;

                hintTimer = setTimeout(() => {
                    const targetMonster = monsters.find(m => m.id === currentTarget && !m.dead);
                    if (targetMonster && targetMonster.el) {
                        targetMonster.el.classList.add('hint-active');
                    }
                }, delay);
            }
        }

        function startGame() {
            startScreen.style.display = 'none';
            createMonsters();
            isGameRunning = true; 
            resetHintTimer(); 
            
            startTime = performance.now();
            
            const timeLimit = DEFAULT_TIMEOUT_LIMIT + activeBenefits.timeExtension;

            timerInterval = setInterval(() => {
                const t = (performance.now() - startTime) / 1000;
                timerDisplay.textContent = t.toFixed(3);
                if (t > timeLimit) handleTimeOut();
            }, 10);
            
            if (!animId) loop();
            
            // Î≥¥Î¨º ÏÉÅÏûê ÎûúÎç§ Îì±Ïû• (5Ï¥à~25Ï¥à ÏÇ¨Ïù¥ ÎûúÎç§)
            scheduleTreasureChest();
        }
        
        function scheduleTreasureChest() {
            if (treasureChestTimer) {
                clearTimeout(treasureChestTimer);
                treasureChestTimer = null;
            }
            
            // 30% ÌôïÎ•†Î°úÎßå Îì±Ïû•
            if (Math.random() > 0.3) {
                return; // Î≥¥Î¨º ÏÉÅÏûê Îì±Ïû•ÌïòÏßÄ ÏïäÏùå
            }
            
            // 5Ï¥à~25Ï¥à ÏÇ¨Ïù¥ ÎûúÎç§ ÏãúÍ∞ÑÏóê Îì±Ïû•
            const delay = 5000 + Math.random() * 20000;
            
            treasureChestTimer = setTimeout(() => {
                if (isGameRunning) {
                    spawnTreasureChest();
                }
            }, delay);
        }
        
        function spawnTreasureChest() {
            // Í∏∞Ï°¥ Î≥¥Î¨º ÏÉÅÏûêÍ∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
            if (treasureChestElement) {
                treasureChestElement.remove();
                treasureChestElement = null;
            }
            
            const w = gameArena.clientWidth;
            const h = gameArena.clientHeight;
            const chestSize = window.innerWidth < 768 ? 80 : 100;
            
            const x = Math.random() * (w - chestSize - 20) + 10;
            const y = Math.random() * (h - chestSize - 20) + 10;
            
            const chest = document.createElement('div');
            chest.className = 'treasure-chest';
            chest.style.left = x + 'px';
            chest.style.top = y + 'px';
            chest.innerHTML = `
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="10" y="50" width="80" height="40" fill="#8B4513" stroke="#654321" stroke-width="2"/>
                    <rect x="10" y="30" width="80" height="25" fill="#D2691E" stroke="#8B4513" stroke-width="2"/>
                    <rect x="40" y="20" width="20" height="15" fill="#FFD700" stroke="#FFA500" stroke-width="2"/>
                    <circle cx="30" cy="65" r="5" fill="#FFD700"/>
                    <circle cx="70" cy="65" r="5" fill="#FFD700"/>
                    <path d="M 10 30 L 50 20 L 90 30" fill="none" stroke="#654321" stroke-width="2"/>
                </svg>
            `;
            
            chest.onmousedown = chest.ontouchstart = (e) => {
                e.preventDefault();
                e.stopPropagation();
                collectTreasureChest();
            };
            
            gameArena.appendChild(chest);
            treasureChestElement = chest;
            
            // 5Ï¥à ÌõÑ ÏûêÎèô ÏÇ¨ÎùºÏßê
            setTimeout(() => {
                if (treasureChestElement === chest) {
                    removeTreasureChest();
                }
            }, 5000);
        }
        
        function collectTreasureChest() {
            if (!treasureChestElement) return;
            
            // ÏãúÍ∞Ñ 1Ï¥à Ï¶ùÍ∞Ä
            activeBenefits.timeExtension += 1;
            
            // "ÏãúÍ∞Ñ +1" ÌÖçÏä§Ìä∏ ÌëúÏãú
            const chestRect = treasureChestElement.getBoundingClientRect();
            const arenaRect = gameArena.getBoundingClientRect();
            const textX = (chestRect.left + chestRect.width / 2) - arenaRect.left;
            const textY = (chestRect.top + chestRect.height / 2) - arenaRect.top;
            
            const textEl = document.createElement('div');
            textEl.className = 'treasure-text';
            textEl.textContent = 'ÏãúÍ∞Ñ +1';
            textEl.style.left = textX + 'px';
            textEl.style.top = textY + 'px';
            textEl.style.transform = 'translate(-50%, -50%)';
            gameArena.appendChild(textEl);
            
            // ÌÖçÏä§Ìä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò ÌõÑ Ï†úÍ±∞
            setTimeout(() => {
                textEl.remove();
            }, 1000);
            
            // Î≥¥Î¨º ÏÉÅÏûê Ï†úÍ±∞
            removeTreasureChest();
            
            // Îã§Ïùå Î≥¥Î¨º ÏÉÅÏûê Ïä§ÏºÄÏ§ÑÎßÅ
            scheduleTreasureChest();
        }
        
        function removeTreasureChest() {
            if (treasureChestElement) {
                treasureChestElement.remove();
                treasureChestElement = null;
            }
        }
        
        function handleTimeOut() {
            isGameRunning = false;
            clearInterval(timerInterval);
            if (animId) { cancelAnimationFrame(animId); animId = null; }
            if (hintTimer) { clearTimeout(hintTimer); hintTimer = null; }
            if (treasureChestTimer) { clearTimeout(treasureChestTimer); treasureChestTimer = null; }
            removeTreasureChest();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur pointer-events-auto';
            modal.innerHTML = `
                <div class="start-panel" style="background-image: none; background-color: #292524; color: white;">
                    <div class="text-7xl mb-4">‚è∞</div>
                    <h2 class="text-3xl font-black text-red-500 mb-2">TIME OUT!</h2>
                    <p class="text-stone-600 mb-6 font-bold text-xl">Ï†úÌïú ÏãúÍ∞Ñ Ï¥àÍ≥º!</p>
                    <button id="retry-btn" class="start-btn text-xl">TRY AGAIN</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('retry-btn').onclick = () => { modal.remove(); resetGame(); };
        }

        function updateStatusDisplay() {
            stageDisplay.textContent = currentStage;
            currentTargetDisplay.textContent = currentTarget;
            totalMonstersDisplay.textContent = totalMonstersInStage;
        }

        function loop() {
            if(isGameRunning) {
                const monsterSize = getMonsterSize();
                monsters.forEach(m => {
                    if(m.dead) return;
                    m.x += m.vx; m.y += m.vy;
                    
                    if(m.x <= m.bounds.minX || m.x >= m.bounds.maxX - monsterSize) {
                        m.vx *= -1;
                        m.x = Math.max(m.bounds.minX, Math.min(m.x, m.bounds.maxX - monsterSize));
                    }
                    if(m.y <= m.bounds.minY || m.y >= m.bounds.maxY - monsterSize) {
                        m.vy *= -1;
                        m.y = Math.max(m.bounds.minY, Math.min(m.y, m.bounds.maxY - monsterSize));
                    }
                    
                    m.el.style.transform = `translate(${m.x}px, ${m.y}px)`;
                    m.el.style.zIndex = Math.floor(m.y) + 50; // Z-Index Î≥¥Ï†ï (Ïö∏ÌÉÄÎ¶¨ ÏúÑ)
                    const body = m.el.querySelector('.monster-body');
                    if(m.vx > 0) body.style.transform = 'scaleX(-1)'; 
                    else body.style.transform = 'scaleX(1)'; 
                });
                
                // Î≥¥Ïä§ Ïù¥Îèô Ï≤òÎ¶¨
                if (bossMonster && bossMonster.hp > 0) {
                    bossMonster.x += bossMonster.vx;
                    bossMonster.y += bossMonster.vy;
                    
                    if(bossMonster.x <= bossMonster.bounds.minX || bossMonster.x >= bossMonster.bounds.maxX - bossMonster.size) {
                        bossMonster.vx *= -1;
                        bossMonster.x = Math.max(bossMonster.bounds.minX, Math.min(bossMonster.x, bossMonster.bounds.maxX - bossMonster.size));
                    }
                    if(bossMonster.y <= bossMonster.bounds.minY || bossMonster.y >= bossMonster.bounds.maxY - bossMonster.size) {
                        bossMonster.vy *= -1;
                        bossMonster.y = Math.max(bossMonster.bounds.minY, Math.min(bossMonster.y, bossMonster.bounds.maxY - bossMonster.size));
                    }
                    
                    bossMonster.el.style.transform = `translate(${bossMonster.x}px, ${bossMonster.y}px)`;
                    bossMonster.el.style.zIndex = Math.floor(bossMonster.y) + 50;
                    const bossBody = bossMonster.el.querySelector('.monster-body');
                    if(bossMonster.vx > 0) bossBody.style.transform = 'scaleX(-1)'; 
                    else bossBody.style.transform = 'scaleX(1)';
                }
                
                animId = requestAnimationFrame(loop);
            } else { animId = null; }
        }

        function handleClick(e) {
            if(!isGameRunning) return;
            
            e.preventDefault();
            const el = e.currentTarget;
            const num = parseInt(el.dataset.number);
            const m = monsters.find(obj => obj.el === el);
            if(m.dead) return;

            if(num === currentTarget) {
                m.dead = true;
                // ÌòÑÏû¨ transform Í∞íÏùÑ CSS Î≥ÄÏàòÎ°ú Ï†ÄÏû•ÌïòÏó¨ Ïï†ÎãàÎ©îÏù¥ÏÖòÏóêÏÑú ÏÇ¨Ïö©
                const currentTransform = el.style.transform || `translate(${m.x}px, ${m.y}px)`;
                el.style.setProperty('--monster-transform', currentTransform);
                el.classList.add('dying'); 
                el.classList.remove('hint-active'); 
                
                // ÌÅ¥Î¶≠Ìïú ÏúÑÏπòÏóêÏÑú ÍπúÎπ°ÏûÑ Ìö®Í≥º
                const arenaRect = gameArena.getBoundingClientRect();
                let clientX, clientY;
                
                // Ïù¥Î≤§Ìä∏ ÌÉÄÏûÖÏóê Îî∞Îùº Ï¢åÌëú Í∞ÄÏ†∏Ïò§Í∏∞
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else if (e.changedTouches && e.changedTouches.length > 0) {
                    clientX = e.changedTouches[0].clientX;
                    clientY = e.changedTouches[0].clientY;
                } else if (e.clientX !== undefined && e.clientY !== undefined) {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else {
                    // Ï¢åÌëúÎ•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏúºÎ©¥ Î™¨Ïä§ÌÑ∞ ÏöîÏÜåÏùò Ï§ëÏã¨Ï†ê ÏÇ¨Ïö©
                    const elRect = el.getBoundingClientRect();
                    clientX = elRect.left + elRect.width / 2;
                    clientY = elRect.top + elRect.height / 2;
                }
                
                // gameArena Í∏∞Ï§Ä ÏÉÅÎåÄ Ï¢åÌëúÎ°ú Î≥ÄÌôò (getBoundingClientRectÎäî Î∑∞Ìè¨Ìä∏ Í∏∞Ï§ÄÏù¥ÎØÄÎ°ú Ïä§ÌÅ¨Î°§ Î∂àÌïÑÏöî)
                const clickX = clientX - arenaRect.left;
                const clickY = clientY - arenaRect.top;
                
                createExplosion(clickX, clickY, m.color);

                currentTarget++;
                resetHintTimer(); 

                // Î≥¥Ïä§Í∞Ä ÏûàÏúºÎ©¥ Î≥¥Ïä§Î•º Ïû°Í∏∞ Ï†ÑÍπåÏßÄ Ïä§ÌÖåÏù¥ÏßÄ ÌÅ¥Î¶¨Ïñ¥ ÏïàÎê®
                if(currentTarget > totalMonstersInStage) {
                    if (bossMonster && bossMonster.hp > 0) {
                        // Î≥¥Ïä§Í∞Ä ÏûàÏúºÎ©¥ Ïä§ÌÖåÏù¥ÏßÄ ÌÅ¥Î¶¨Ïñ¥ ÏïàÎê®
                        updateStatusDisplay();
                    } else {
                        handleStageClear();
                    }
                } else {
                    updateStatusDisplay();
                }
            } else {
                gameArena.classList.remove('shake-screen');
                void gameArena.offsetWidth;
                gameArena.classList.add('shake-screen');
                setTimeout(() => gameArena.classList.remove('shake-screen'), 400);
            }
        }

        function toggleStats() {
            if (statsModal.style.display === 'none') {
                statsModal.style.display = 'flex';
                updateStatsContent();
            } else {
                statsModal.style.display = 'none';
            }
        }

        function updateStatsContent() {
            let html = '';
            
            const addRow = (icon, label, value) => {
                html += `<div class="stat-item">
                    <div class="flex items-center gap-2"><span>${icon}</span> <span>${label}</span></div>
                    <span class="stat-val">${value}</span>
                </div>`;
            };

            addRow('‚öîÔ∏è', 'ÏãúÏûë ÌÇ¨', `+${activeBenefits.initialKill}ÎßàÎ¶¨`);
            addRow('üêå', 'ÏÜçÎèÑ Í∞êÏÜå', `-${activeBenefits.slowPercent}%`);
            addRow('‚è≥', 'ÏãúÍ∞Ñ Ïó∞Ïû•', `+${activeBenefits.timeExtension}Ï¥à`);
            addRow('‚úÇÔ∏è', 'ÌíÄÏà≤ Ï†úÍ±∞', `-${activeBenefits.bushRemoval}Í∞ú`);
            addRow('üöß', 'Ïö∏ÌÉÄÎ¶¨', activeBenefits.fenceLevel > 0 ? 'Î≥¥Ïú†Ï§ë' : 'ÏóÜÏùå');
            const lightSec = activeBenefits.lightLevel === 0 ? '-' : (activeBenefits.lightLevel === 1 ? '2Ï¥à' : (activeBenefits.lightLevel === 2 ? '1.5Ï¥à' : '1Ï¥à'));
            addRow('üí°', 'Î∂àÎπõ ÌûåÌä∏', lightSec);
            addRow('‚ûï', 'ÏÑ†ÌÉùÏßÄ ÌôïÏû•', `+${activeBenefits.extraOptions}Í∞ú`);

            statsListContent.innerHTML = html;
        }

        function startBonusRound(limitTime) {
            bonusLayer.innerHTML = '';
            bonusLayer.style.display = 'flex';
            
            const intro = document.createElement('div');
            intro.className = 'start-panel';
            // Î≥¥ÎÑàÏä§ ÎùºÏö¥Îìú ÏïàÎÇ¥Îäî Î∞∞Í≤Ω ÏóÜÏù¥ ÍπîÎÅîÌïòÍ≤å
            intro.style.backgroundImage = 'none';
            intro.style.backgroundColor = '#292524';
            intro.style.color = 'white';
            intro.style.justifyContent = 'center';

            intro.innerHTML = `
                <h2 class="text-4xl font-black text-red-500 mb-2">‚ö†Ô∏è WARNING!</h2>
                <p class="text-stone-300 mb-4 font-bold text-lg">Í±∞ÎåÄ Î™¨Ïä§ÌÑ∞ Ï∂úÌòÑ!</p>
                <p class="text-green-500 text-sm mb-6">ÎÇòÌÉÄÎÇòÎäî ÏàúÍ∞Ñ ${limitTime}Ï¥à ÏïàÏóê ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî!</p>
                <button id="bonus-ready-btn" class="start-btn text-xl">READY</button>
            `;
            bonusLayer.appendChild(intro);

            document.getElementById('bonus-ready-btn').onclick = () => {
                intro.remove();
                const waitTime = 1000 + Math.random() * 2000;
                setTimeout(() => {
                    spawnGiantMonster(limitTime);
                }, waitTime);
            };
        }

        function spawnGiantMonster(limitTime) {
            const monster = document.createElement('div');
            monster.className = 'monster-entity giant-monster';
            monster.innerHTML = getMonsterHTML('slime', '#ff0000', '#990000');
            
            const w = window.innerWidth;
            const h = window.innerHeight;
            const x = Math.random() * (w - 250) + 25;
            const y = Math.random() * (h - 250) + 125;
            monster.style.left = `${x}px`;
            monster.style.top = `${y}px`;
            
            bonusLayer.appendChild(monster);
            
            const spawnTime = performance.now();
            
            monster.onmousedown = monster.ontouchstart = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const clickTime = performance.now();
                const duration = (clickTime - spawnTime) / 1000;
                
                monster.remove();
                
                if (duration <= limitTime) {
                    showBonusResult(true, duration, 2);
                } else {
                    showBonusResult(false, duration, 1);
                }
            };
        }

        function showBonusResult(success, time, picks) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'start-panel';
            resultDiv.style.zIndex = 200;
            resultDiv.style.backgroundImage = 'none';
            resultDiv.style.backgroundColor = '#292524';
            resultDiv.style.color = 'white';
            resultDiv.style.justifyContent = 'center';
            
            const title = success ? "SUCCESS! üéâ" : "TOO SLOW... üê¢";
            const color = success ? "text-green-500" : "text-stone-500";
            
            resultDiv.innerHTML = `
                <h2 class="text-4xl font-black ${color} mb-2">${title}</h2>
                <p class="text-stone-300 mb-2 font-bold">Î∞òÏùë ÏÜçÎèÑ: ${time.toFixed(3)}Ï¥à</p>
                <p class="text-stone-400 mb-6 text-sm">Î≥¥ÏÉÅ: Î≤†ÎÑ§Ìïè ${picks}Í∞ú ÏÑ†ÌÉù Í∞ÄÎä•</p>
                <button id="bonus-ok-btn" class="start-btn text-xl">ÌôïÏù∏</button>
            `;
            bonusLayer.appendChild(resultDiv);
            
            document.getElementById('bonus-ok-btn').onclick = () => {
                bonusLayer.innerHTML = '';
                bonusLayer.style.display = 'none';
                showBenefitModal(picks);
            };
        }

        function showBenefitModal(pickCount) {
            const benefits = generateBenefits();
            let picksLeft = pickCount;

            const modal = document.createElement('div');
            modal.id = 'clear-modal';
            modal.className = 'fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur pointer-events-auto';
            
            const updateUI = () => {
                let cardsHtml = benefits.map((b, index) => `
                    <div class="benefit-card ${b.cssClass} ${b.picked ? 'selected' : ''}" data-index="${index}">
                        <div class="card-icon">${b.icon}</div>
                        <div class="card-title">${b.title}</div>
                        <div class="card-desc">${b.desc}</div>
                    </div>
                `).join('');

                const containerClass = benefits.length > 3 ? 'benefit-container many-items' : 'benefit-container';

                modal.innerHTML = `
                    <div class="start-panel" style="background-image: none; background-color: #292524; color: white; max-width: 800px; justify-content: center;">
                        <div class="text-6xl mb-2">üéâ</div>
                        <h2 class="text-3xl font-black text-white mb-2">STAGE ${currentStage} CLEAR!</h2>
                        <p class="text-yellow-300 font-bold mb-2 text-xl">Î≥¥ÏÉÅÏùÑ ${picksLeft}Í∞ú ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!</p>
                        <div class="${containerClass}">${cardsHtml}</div>
                        <button id="modal-stats-btn" class="bg-blue-600 text-white px-4 py-2 rounded-xl mt-4 font-bold">üìä Ïä§ÌÉØ Î≥¥Í∏∞</button>
                    </div>
                `;
                
                modal.querySelector('#modal-stats-btn').onclick = toggleStats;

                modal.querySelectorAll('.benefit-card').forEach(card => {
                    if(!card.classList.contains('selected')) {
                        card.onclick = () => {
                            const idx = card.dataset.index;
                            applyBenefit(benefits[idx]);
                            benefits[idx].picked = true;
                            picksLeft--;
                            
                            if (picksLeft <= 0) {
                                modal.remove();
                                loadStageConfig(currentStage + 1);
                                updateStatusDisplay();
                                startGame();
                            } else {
                                updateUI();
                            }
                        };
                    }
                });
            };
            
            document.body.appendChild(modal);
            updateUI();
        }

        function generateBenefits() {
            const nextStageConfig = getStageConfig(currentStage + 1);
            let availableTypes = [BENEFIT_TYPES.KILL, BENEFIT_TYPES.SLOW, BENEFIT_TYPES.TIME, BENEFIT_TYPES.EXTRA_OPTION];
            
            if (currentStage >= 3) {
                if (nextStageConfig.bushCount > 0) availableTypes.push(BENEFIT_TYPES.REMOVE_BUSH);
                if (activeBenefits.fenceLevel < 1 && Math.random() < 0.1) availableTypes.push(BENEFIT_TYPES.FENCE);
                if (activeBenefits.lightLevel < 3) availableTypes.push(BENEFIT_TYPES.LIGHT);
            }

            for (let i = availableTypes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableTypes[i], availableTypes[j]] = [availableTypes[j], availableTypes[i]];
            }

            const selectionCount = 3 + activeBenefits.extraOptions;
            const selectedTypes = availableTypes.slice(0, selectionCount);
            const options = [];

            selectedTypes.forEach(type => {
                let rarity, value, title, desc, icon, cssClass;
                
                if (type === BENEFIT_TYPES.EXTRA_OPTION) {
                    rarity = 'rare'; value = 1; cssClass = 'rarity-rare'; title = "ÏÑ†ÌÉùÏßÄ ÌôïÏû•"; desc = "Î≥¥ÏÉÅ ÏÑ†ÌÉùÏßÄ 1Í∞ú Ï∂îÍ∞Ä"; icon = "‚ûï";
                } else if (type === BENEFIT_TYPES.REMOVE_BUSH) {
                    rarity = 'rare'; value = 1; cssClass = 'rarity-rare'; title = "Ï†úÏ¥à ÏûëÏóÖ"; desc = "Îã§ÏùåÎ∂ÄÌÑ∞ ÌíÄÏà≤ 1Í∞ú Ï†úÍ±∞"; icon = "‚úÇÔ∏è";
                } else if (type === BENEFIT_TYPES.FENCE) {
                    rarity = 'legend'; value = 1; cssClass = 'rarity-legend'; title = "Ïö∏ÌÉÄÎ¶¨ ÏÑ§Ïπò"; desc = "Î™¨Ïä§ÌÑ∞Î•º Íµ¨Ïó≠Î≥ÑÎ°ú Ï†ïÎ†¨"; icon = "üöß";
                } else if (type === BENEFIT_TYPES.LIGHT) {
                    rarity = 'rare'; value = 1; cssClass = 'rarity-rare'; title = "Î∂àÎπõ ÌûåÌä∏"; 
                    const sec = activeBenefits.lightLevel === 0 ? 2 : (activeBenefits.lightLevel === 1 ? 1.5 : 1);
                    desc = `${sec}Ï¥à ÏßÄÏó∞ Ïãú ÌûåÌä∏ ÌëúÏãú`; icon = "üí°";
                } else {
                    const randRarity = Math.random();
                    if (type === BENEFIT_TYPES.KILL) {
                        if (randRarity < 0.7) { rarity = 'normal'; value = 1; cssClass = 'rarity-normal'; }
                        else if (randRarity < 0.9) { rarity = 'rare'; value = 2; cssClass = 'rarity-rare'; }
                        else { rarity = 'legend'; value = 3; cssClass = 'rarity-legend'; }
                        title = "ÏãúÏûë ÌÇ¨"; desc = `ÏãúÏûë Ïãú Î™¨Ïä§ÌÑ∞ ${value}ÎßàÎ¶¨ ÏûêÎèô Ï≤òÏπò`; icon = "‚öîÔ∏è";
                    } else if (type === BENEFIT_TYPES.SLOW) {
                        if (randRarity < 0.8) { rarity = 'normal'; value = 10; cssClass = 'rarity-normal'; }
                        else if (randRarity < 0.95) { rarity = 'rare'; value = 20; cssClass = 'rarity-rare'; }
                        else { rarity = 'legend'; value = 30; cssClass = 'rarity-legend'; }
                        title = "ÏÜçÎèÑ Í∞êÏÜå"; desc = `Î™®Îì† Î™¨Ïä§ÌÑ∞ ÏÜçÎèÑ ${value}% Í∞êÏÜå`; icon = "üêå";
                    } else if (type === BENEFIT_TYPES.TIME) {
                        if (randRarity < 0.8) { rarity = 'normal'; value = 3; cssClass = 'rarity-normal'; }
                        else if (randRarity < 0.95) { rarity = 'rare'; value = 6; cssClass = 'rarity-rare'; }
                        else { rarity = 'legend'; value = 9; cssClass = 'rarity-legend'; }
                        title = "ÏãúÍ∞Ñ Ïó∞Ïû•"; desc = `Ï†úÌïú ÏãúÍ∞Ñ ${value}Ï¥à Ï¶ùÍ∞Ä`; icon = "‚è≥";
                    }
                }
                options.push({ type, rarity, value, title, desc, icon, cssClass, picked: false });
            });
            return options;
        }

        function applyBenefit(benefit) {
            if (benefit.type === BENEFIT_TYPES.KILL) activeBenefits.initialKill += benefit.value;
            if (benefit.type === BENEFIT_TYPES.SLOW) activeBenefits.slowPercent += benefit.value;
            if (benefit.type === BENEFIT_TYPES.TIME) activeBenefits.timeExtension += benefit.value;
            if (benefit.type === BENEFIT_TYPES.REMOVE_BUSH) activeBenefits.bushRemoval += benefit.value;
            if (benefit.type === BENEFIT_TYPES.FENCE) activeBenefits.fenceLevel += 1;
            if (benefit.type === BENEFIT_TYPES.LIGHT) activeBenefits.lightLevel += 1;
            if (benefit.type === BENEFIT_TYPES.EXTRA_OPTION) activeBenefits.extraOptions += benefit.value;
        }

        async function handleStageClear() {
            isGameRunning = false;
            clearInterval(timerInterval);
            if (animId) { cancelAnimationFrame(animId); animId = null; }
            if (hintTimer) { clearTimeout(hintTimer); hintTimer = null; }
            if (treasureChestTimer) { clearTimeout(treasureChestTimer); treasureChestTimer = null; }
            removeTreasureChest();

            const score = timerDisplay.textContent;
            if(db) await addDoc(collection(db, COLLECTION_PATH), { stage: currentStage, time: parseFloat(score), timestamp: serverTimestamp() });

            if (currentStage === 3) {
                startBonusRound(0.4); // 0.5 -> 0.4s
                return;
            }
            if (currentStage === 5) {
                startBonusRound(0.3); // 0.4 -> 0.3s
                return;
            }
            if (currentStage === 8) {
                startBonusRound(0.28); // 0.38 -> 0.28s
                return;
            }

            showBenefitModal(1);
        }

        // Leaderboard logic retained for backend connectivity if needed later, 
        // but removed from start screen display.
        function setupLeaderboard() {
            // Function body kept to prevent errors if called, though no element to populate.
        }

        init();
    </script>
</body>
</html>
