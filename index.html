<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Î™¨Ïä§ÌÑ∞ Îü¨Ïâ¨: Ìåú Ïä§ÌÖåÏù¥ÏßÄ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        /* Í∏∞Î≥∏ ÏÑ§Ï†ï */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Jua', sans-serif;
            -webkit-user-select: none;
            user-select: none;
            background-color: #1c1917;
            margin: 0;
            padding: 0;
        }
        
        /* ÌôîÎ©¥ ÌùîÎì§Î¶º Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-screen { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        
        /* Î∂àÎπõ ÌûåÌä∏ Ïï†ÎãàÎ©îÏù¥ÏÖò (ÏúÑÏπò Ïù¥Îèô Í∞ÑÏÑ≠ Ï†úÍ±∞) */
        @keyframes hint-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        .hint-active {
            animation: hint-pulse 1s infinite;
            z-index: 9999 !important;
            filter: brightness(1.5) drop-shadow(0 0 10px gold) !important;
        }

        /* ÏÉÅÎã® HUD Î∞î */
        .hud-bar {
            height: 100px;
            background: #1c1917;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            pointer-events: auto;
            border-bottom: 6px solid #44403c;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            z-index: 100;
            position: relative;
            flex-shrink: 0;
        }
        @media (min-width: 768px) { .hud-bar { gap: 40px; } }

        #game-arena {
            position: absolute;
            top: 100px;
            left: 0;
            width: 100vw;
            height: calc(100dvh - 100px); 
            background-color: #4ade80;
            background-image: url('https://raw.githubusercontent.com/chalchichi/testresource/main/Gemini_Generated_Image_p0oedlp0oedlp0oe.png'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            cursor: crosshair;
            z-index: 0;
            overflow: hidden;
        }

        /* Ïö∏ÌÉÄÎ¶¨ Ïä§ÌÉÄÏùº */
        .fence-line {
            position: absolute;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHBhdGggZD0iTTAgMEwyMCAyME0yMCAwTDAgMjAiIHN0cm9rZT0iIzVkNDAzNyIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+');
            background-color: #795548;
            border: 2px solid #3e2723;
            z-index: 50;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .fence-horizontal {
            top: 50%; left: 0; width: 100%; height: 16px;
            transform: translateY(-50%);
        }
        .fence-vertical {
            top: 0; left: 50%; width: 16px; height: 100%;
            transform: translateX(-50%);
        }

        .hud-item { display: flex; flex-direction: column; align-items: center; }
        .hud-label { font-size: 0.8rem; color: #d6d3d1; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 2px; }
        @media (min-width: 768px) { .hud-label { font-size: 1rem; } }
        .hud-value { font-family: 'Jua', sans-serif; font-size: 1.5rem; line-height: 1; }
        @media (min-width: 768px) { .hud-value { font-size: 2rem; } }

        #timer {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-variant-numeric: tabular-nums;
            letter-spacing: -1px;
            min-width: 80px;
            text-align: center;
        }
        @media (min-width: 768px) { #timer { min-width: 120px; } }

        .monster-entity {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 64px;
            height: 64px;
            cursor: pointer;
            will-change: transform;
            filter: drop-shadow(0 6px 4px rgba(0,0,0,0.4));
            transition: opacity 0.3s, transform 0.1s;
        }

        /* Î≥¥ÎÑàÏä§ ÎùºÏö¥ÎìúÏö© Í±∞ÎåÄ Î™¨Ïä§ÌÑ∞ */
        .giant-monster {
            width: 200px !important;
            height: 200px !important;
            z-index: 9999;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.6));
        }

        .bush-obstacle {
            position: absolute;
            width: 120px;
            height: 100px;
            pointer-events: none;
            z-index: 9990;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3));
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }
        .bush-svg { width: 100%; height: 100%; fill: #15803d; stroke: #052e16; stroke-width: 3px; }

        #start-screen {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px); z-index: 200;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; height: 100dvh;
        }

        .start-panel {
            background-image: url('https://raw.githubusercontent.com/chalchichi/testresource/main/background.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border: 6px solid #ffffff; border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 0 10px rgba(0,0,0,0.1);
            padding: 30px 20px; max-width: 500px; width: 100%;
            max-height: 85dvh; overflow-y: auto;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }
        @media (min-width: 768px) {
            .start-panel { border: 8px solid #ffffff; border-radius: 40px; padding: 50px; overflow: hidden; }
        }

        .game-title {
            font-size: 3.5rem; color: #ffffff;
            -webkit-text-stroke: 6px #15803d; paint-order: stroke fill;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.2); line-height: 1.1;
            margin-bottom: 10px; position: relative; z-index: 10; flex-shrink: 0;
        }
        @media (min-width: 768px) {
            .game-title { font-size: 4.5rem; -webkit-text-stroke: 8px #15803d; margin-bottom: 20px; }
        }

        .info-box {
            background: rgba(255, 255, 255, 0.9); border-radius: 20px;
            padding: 12px 20px; margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: #1c1917;
            position: relative; z-index: 10; border: 3px solid #e5e7eb; flex-shrink: 0;
        }

        .start-btn {
            background: linear-gradient(to bottom, #4ade80, #16a34a);
            color: white; font-size: 1.8rem; padding: 12px 30px;
            border-radius: 20px; box-shadow: 0 6px 0 #14532d, 0 10px 10px rgba(0,0,0,0.2);
            transition: all 0.1s; display: inline-block; width: 100%;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.1); position: relative;
            z-index: 10; border: 2px solid #ffffff; flex-shrink: 0;
        }
        @media (min-width: 768px) { .start-btn { font-size: 2.2rem; padding: 15px 40px; } }
        .start-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #14532d; }

        .ranking-box {
            background: rgba(0, 0, 0, 0.6); border-radius: 16px;
            padding: 15px; margin-top: 15px; border: 2px solid rgba(255,255,255,0.3);
            position: relative; z-index: 10; width: 100%; flex-shrink: 1;
            min-height: 0; display: flex; flex-direction: column;
        }

        .monster-body { width: 100%; height: 100%; position: relative; }
        .slime-body { fill: var(--monster-color); stroke: #14532d; stroke-width: 2.5px; }
        .slime-anim { animation: slime-bounce 0.6s infinite alternate cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slime-bounce { 0% { transform: scaleY(0.9) scaleX(1.1) translateY(5px); } 100% { transform: scaleY(1.1) scaleX(0.9) translateY(-5px); } }
        .mushroom-cap { fill: var(--monster-color); stroke: #14532d; stroke-width: 2.5px; }
        .mushroom-stem { fill: #fff3e0; stroke: #14532d; stroke-width: 2.5px; }
        .mushroom-anim { animation: mushroom-walk 0.4s infinite alternate ease-in-out; }
        @keyframes mushroom-walk { 0% { transform: rotate(-5deg); } 100% { transform: rotate(5deg); } }
        .bat-body { fill: var(--monster-color); stroke: #14532d; stroke-width: 2.5px; }
        .bat-wing { fill: var(--monster-dark-color); stroke: #14532d; stroke-width: 1px; }
        .bat-anim { animation: bat-fly 0.2s infinite alternate ease-in-out; }
        @keyframes bat-fly { 0% { transform: translateY(0); } 100% { transform: translateY(-8px); } }
        .ghost-body { fill: #f8fafc; stroke: #14532d; stroke-width: 2.5px; opacity: 0.95; }
        .ghost-anim { animation: ghost-float 1.5s infinite ease-in-out; }
        @keyframes ghost-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        .eye { fill: white; }
        .pupil { fill: #14532d; }

        .number-badge {
            position: absolute; top: -18px; background: #fbbf24;
            color: #1c1917; font-size: 16px; font-weight: 900;
            padding: 2px 10px; border-radius: 12px; border: 3px solid #ffffff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 20;
        }
        .dead { pointer-events: none; opacity: 0; transform: scale(0); transition: all 0.3s; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #5d4037; border-radius: 10px; }

        /* Benefit Cards Styles */
        .benefit-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
        }
        @media (max-width: 600px) {
            .benefit-container {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        .benefit-card {
            background: linear-gradient(to bottom, #ffffff, #f3f4f6);
            border: 4px solid #e5e7eb;
            border-radius: 16px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 140px;
            position: relative;
            overflow: hidden;
        }
        .benefit-card:hover { transform: translateY(-5px); filter: brightness(1.05); }
        .benefit-card:active { transform: scale(0.95); }
        .benefit-card.selected { border-color: #22c55e; background: #dcfce7; opacity: 0.5; pointer-events: none; }
        
        .rarity-normal { border-color: #9ca3af; box-shadow: 0 4px 0 #6b7280; }
        .rarity-normal .card-title { color: #4b5563; }
        
        .rarity-rare { border-color: #3b82f6; box-shadow: 0 4px 0 #1d4ed8; }
        .rarity-rare .card-title { color: #2563eb; }
        .rarity-rare::before {
            content: "RARE"; position: absolute; top: 0; right: 0;
            background: #3b82f6; color: white; font-size: 0.6rem; padding: 2px 6px;
            border-bottom-left-radius: 8px;
        }

        .rarity-legend { border-color: #eab308; box-shadow: 0 4px 0 #a16207; background: linear-gradient(to bottom, #fffbeb, #fef3c7); }
        .rarity-legend .card-title { color: #ca8a04; text-shadow: 0 1px 0 rgba(0,0,0,0.1); }
        .rarity-legend::before {
            content: "LEGEND"; position: absolute; top: 0; right: 0;
            background: #eab308; color: black; font-size: 0.6rem; padding: 2px 6px;
            border-bottom-left-radius: 8px; font-weight: bold;
        }

        .card-icon { font-size: 2rem; margin-bottom: 5px; }
        .card-title { font-weight: 900; font-size: 1rem; margin-bottom: 4px; line-height: 1.1; }
        .card-desc { font-size: 0.8rem; color: #6b7280; line-height: 1.2; word-break: keep-all; }

        /* Active Benefits HUD - ÏôºÏ™Ω ÏÉÅÎã® */
        #active-benefits {
            position: fixed;
            top: 110px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 90;
            pointer-events: none;
            align-items: flex-start;
        }
        .active-benefit-item {
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
            backdrop-filter: blur(2px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
        }

        /* Bonus Layer */
        #bonus-layer {
            position: fixed; inset: 0; z-index: 150;
            display: none; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.3);
        }

    </style>
</head>
<body>

    <div class="hud-bar">
        <div class="hud-item">
            <span class="hud-label">STAGE</span>
            <span class="hud-value text-yellow-400" id="stage-display">1</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">TARGET</span>
            <div class="hud-value text-white bg-stone-800 px-3 py-1 md:px-4 md:py-1 rounded-xl border-2 border-stone-600">
                <span id="current-target">1</span>
                <span class="text-base md:text-xl text-stone-500 font-normal">/ <span id="total-monsters-display">10</span></span>
            </div>
        </div>
        <div class="hud-item ml-2 md:ml-10">
            <span class="hud-label">TIME</span>
            <span class="hud-value text-green-400" id="timer">0.000</span>
        </div>
        <button id="reset-button" class="absolute right-2 md:right-8 bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 text-sm md:px-4 md:py-3 md:text-xl rounded-2xl border-b-4 border-red-800 transition-all active:border-b-0 active:translate-y-1 font-bold">
            ‚ùå Ï¢ÖÎ£å
        </button>
    </div>

    <!-- Active Benefits List -->
    <div id="active-benefits">
        <!-- JSÎ°ú Ï±ÑÏõåÏßê -->
    </div>

    <div id="game-arena"></div>
    <div id="bonus-layer"></div>

    <div id="start-screen">
        <div class="start-panel">
            <div class="text-6xl md:text-8xl mb-2 drop-shadow-xl relative z-10 animate-bounce">üëª</div>
            <h1 class="game-title">MONSTER<br>RUSH</h1>
            
            <div class="info-box">
                <p class="text-lg md:text-xl font-bold text-stone-800">1Î≤àÎ∂ÄÌÑ∞ Ï∞®Î°ÄÎåÄÎ°ú Ïû°ÏïÑÏ£ºÏÑ∏Ïöî!</p>
                <p id="stage-info-text" class="text-green-600 text-sm md:text-base mt-1 font-bold">üå± Stage 1: 10ÎßàÎ¶¨ Ï∂úÎ™∞!</p>
            </div>
            
            <button id="start-button" class="start-btn">GAME START</button>

            <div class="ranking-box">
                <h2 class="text-xs font-black text-white uppercase tracking-widest mb-2 border-b border-white/20 pb-1">HALL OF FAME</h2>
                <ul id="leaderboard" class="space-y-2 text-sm max-h-24 md:max-h-32 overflow-y-auto custom-scrollbar text-left p-1 w-full">
                    <li class="text-center text-stone-300 text-xs py-2">Í∏∞Î°ù Î∂àÎü¨Ïò§Îäî Ï§ë...</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const SPEED_MIN_BASE = 0.3;
        const SPEED_MAX_BASE = 0.8;
        const DEFAULT_TIMEOUT_LIMIT = 30.0;

        const gameArena = document.getElementById('game-arena');
        const bonusLayer = document.getElementById('bonus-layer');
        const currentTargetDisplay = document.getElementById('current-target');
        const totalMonstersDisplay = document.getElementById('total-monsters-display');
        const stageDisplay = document.getElementById('stage-display');
        const timerDisplay = document.getElementById('timer');
        const startScreen = document.getElementById('start-screen');
        const stageInfoText = document.getElementById('stage-info-text');
        const leaderboardEl = document.getElementById('leaderboard');
        const activeBenefitsEl = document.getElementById('active-benefits');
        
        let currentStage = 1;
        let totalMonstersInStage = 10;
        let currentTarget = 1;
        let isGameRunning = false;
        let startTime = 0;
        let timerInterval = null;
        let animId = null;
        let monsters = [];
        let hintTimer = null; // ÌûåÌä∏ ÌÉÄÏù¥Î®∏

        // Benefit State
        let activeBenefits = {
            initialKill: 0,
            slowPercent: 0,
            timeExtension: 0,
            bushRemoval: 0,
            fenceLevel: 0,
            lightLevel: 0
        };

        let app, db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const COLLECTION_PATH = `/artifacts/${appId}/public/data/leaderboard_cute_stage`;

        // Benefit Definitions
        const BENEFIT_TYPES = {
            KILL: 'kill',
            SLOW: 'slow',
            TIME: 'time',
            REMOVE_BUSH: 'remove_bush',
            FENCE: 'fence',
            LIGHT: 'light'
        };

        function getMonsterHTML(type, color, darkColor) {
            const eyes = `<circle class="eye" cx="24" cy="28" r="6" /><circle class="pupil" cx="24" cy="28" r="2.5" /><circle class="eye" cx="40" cy="28" r="6" /><circle class="pupil" cx="40" cy="28" r="2.5" />`;
            if (type === 'slime') return `<div class="monster-body slime-anim" style="--monster-color: ${color}"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="slime-body" d="M10,45 Q10,15 32,15 Q54,15 54,45 Q54,58 50,60 Q32,64 14,60 Q10,58 10,45 Z" />${eyes}</svg></div>`;
            if (type === 'mushroom') return `<div class="monster-body mushroom-anim" style="--monster-color: ${color}"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="mushroom-stem" d="M22,60 L22,35 L42,35 L42,60 Q32,64 22,60 Z" /><path class="mushroom-cap" d="M6,35 Q32,0 58,35 Z" />${eyes}</svg></div>`;
            if (type === 'bat') return `<div class="monster-body bat-anim" style="--monster-color: ${color}; --monster-dark-color: ${darkColor}"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="bat-wing" d="M10,30 Q-5,10 20,25 L20,35 Z" /><path class="bat-wing" d="M54,30 Q69,10 44,25 L44,35 Z" /><ellipse class="bat-body" cx="32" cy="35" rx="14" ry="16" />${eyes}</svg></div>`;
            return `<div class="monster-body ghost-anim"><svg viewBox="0 0 64 64" width="100%" height="100%"><path class="ghost-body" d="M12,60 L12,30 Q12,10 32,10 Q52,10 52,30 L52,60 L42,50 L32,60 L22,50 L12,60 Z" />${eyes}</svg></div>`;
        }

        function getBushHTML() {
            return `<svg class="bush-svg" viewBox="0 0 100 80"><path d="M10,80 Q-10,40 20,30 Q10,10 40,15 Q50,-10 70,20 Q100,0 90,50 Q110,80 80,80 Z" /><path d="M20,80 Q25,50 35,60" fill="none" stroke="#22c55e" stroke-width="2" /><path d="M70,80 Q65,40 55,50" fill="none" stroke="#22c55e" stroke-width="2" /></svg>`;
        }

        const MONSTER_TYPES = ['slime', 'mushroom', 'bat', 'ghost'];
        const COLORS = [{ main: '#f87171', dark: '#991b1b' }, { main: '#fb923c', dark: '#9a3412' }, { main: '#fbbf24', dark: '#92400e' }, { main: '#60a5fa', dark: '#1e40af' }, { main: '#c084fc', dark: '#6b21a8' }, { main: '#f472b6', dark: '#9d174d' }];

        async function init() {
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch(e) {}
                setupLeaderboard();
            }
            document.getElementById('start-button').onclick = startGame;
            document.getElementById('reset-button').onclick = resetGame;
            
            loadStageConfig(1);
            updateStatusDisplay();
            updateActiveBenefitsUI();
        }

        function getStageConfig(stage) {
            let config = { count: 10, speedBonus: 0, bushCount: 0 };
            
            if (stage === 1) { config.count = 10; config.speedBonus = 0; config.bushCount = 0; }
            else if (stage === 2) { config.count = 10; config.speedBonus = 0.3; config.bushCount = 0; }
            else if (stage === 3) { config.count = 15; config.speedBonus = 0.3; config.bushCount = 1; }
            else if (stage === 4) { config.count = 20; config.speedBonus = 0.6; config.bushCount = 1; }
            else if (stage === 5) { config.count = 25; config.speedBonus = 0.6; config.bushCount = 2; }
            else if (stage === 6) { config.count = 30; config.speedBonus = 0.6; config.bushCount = 2; }
            else if (stage === 7) { config.count = 30; config.speedBonus = 0.7; config.bushCount = 2; }
            else if (stage === 8) { config.count = 35; config.speedBonus = 0.7; config.bushCount = 3; }
            else if (stage === 9) { config.count = 40; config.speedBonus = 0.7; config.bushCount = 3; }
            else if (stage === 10) { config.count = 40; config.speedBonus = 0.7; config.bushCount = 4; }
            else {
                config.count = 40 + (stage - 10) * 5;
                config.speedBonus = 0.8 + (stage - 10) * 0.1;
                config.bushCount = 4 + Math.floor((stage - 10) / 2);
            }
            return config;
        }

        function loadStageConfig(stage) {
            const config = getStageConfig(stage);
            currentStage = stage;
            totalMonstersInStage = config.count;
            currentTarget = 1;
            
            let info = `üå± Stage ${stage}: ${config.count}ÎßàÎ¶¨`;
            if(config.speedBonus > 0) info += ` (ÏÜçÎèÑ UP!)`;
            if(config.bushCount > 0) info += ` (ÌíÄÏà≤ ${config.bushCount}Í∞ú)`;
            if(stageInfoText) stageInfoText.textContent = info;
        }

        function resetGame() {
            isGameRunning = false;
            clearInterval(timerInterval);
            if (animId) { cancelAnimationFrame(animId); animId = null; }
            if (hintTimer) { clearTimeout(hintTimer); hintTimer = null; }
            
            document.querySelectorAll('.fixed.z-\\[200\\]').forEach(el => el.remove());
            bonusLayer.style.display = 'none';
            bonusLayer.innerHTML = '';

            startScreen.style.display = 'flex';
            timerDisplay.textContent = '0.000';
            
            activeBenefits = { initialKill: 0, slowPercent: 0, timeExtension: 0, bushRemoval: 0, fenceLevel: 0, lightLevel: 0 };
            updateActiveBenefitsUI();

            loadStageConfig(1);
            updateStatusDisplay();
            gameArena.innerHTML = ''; 
            gameArena.classList.remove('shake-screen');
        }

        function createBushes(count) {
            const finalCount = Math.max(0, count - activeBenefits.bushRemoval);
            const w = gameArena.clientWidth;
            const h = gameArena.clientHeight;
            for(let i=0; i<finalCount; i++) {
                const bush = document.createElement('div');
                bush.className = 'bush-obstacle';
                bush.innerHTML = getBushHTML();
                const bx = Math.random() * (w - 150) + 25;
                const by = Math.random() * (h - 150) + 25;
                bush.style.left = `${bx}px`;
                bush.style.top = `${by}px`;
                gameArena.appendChild(bush);
            }
        }

        function createMonsters() {
            gameArena.innerHTML = '';
            monsters = [];
            
            // Ïö∏ÌÉÄÎ¶¨ ÏÉùÏÑ±
            if (activeBenefits.fenceLevel >= 1) {
                const hFence = document.createElement('div');
                hFence.className = 'fence-line fence-horizontal';
                gameArena.appendChild(hFence);
            }
            if (activeBenefits.fenceLevel >= 2) {
                const vFence = document.createElement('div');
                vFence.className = 'fence-line fence-vertical';
                gameArena.appendChild(vFence);
            }

            const w = gameArena.clientWidth;
            const h = gameArena.clientHeight;
            const config = getStageConfig(currentStage);

            if (config.bushCount > 0) createBushes(config.bushCount);

            for(let i=1; i<=config.count; i++) {
                const el = document.createElement('div');
                el.className = 'monster-entity';
                el.dataset.number = i;
                const type = MONSTER_TYPES[i % 4];
                const colorSet = COLORS[i % COLORS.length];
                
                // Ïö∏ÌÉÄÎ¶¨ Î∞∞Ïπò Î°úÏßÅÏóê Îî∞Îùº Íµ¨Ïó≠ ÏÑ§Ï†ï
                let bounds = { minX: 0, maxX: w, minY: 0, maxY: h };

                if (activeBenefits.fenceLevel === 1) {
                    // Í∞ÄÎ°ú 2Î∂ÑÌï†
                    if (i <= config.count / 2) {
                        bounds.maxY = h / 2; // ÏúÑÏ™Ω
                    } else {
                        bounds.minY = h / 2; // ÏïÑÎûòÏ™Ω
                    }
                } else if (activeBenefits.fenceLevel === 2) {
                    // 4Î∂ÑÌï†
                    const q = Math.ceil(config.count / 4);
                    if (i <= q) { // Ï¢åÏÉÅ
                        bounds.maxX = w / 2;
                        bounds.maxY = h / 2;
                    } else if (i <= q*2) { // Ïö∞ÏÉÅ
                        bounds.minX = w / 2;
                        bounds.maxY = h / 2;
                    } else if (i <= q*3) { // Ï¢åÌïò
                        bounds.maxX = w / 2;
                        bounds.minY = h / 2;
                    } else { // Ïö∞Ìïò
                        bounds.minX = w / 2;
                        bounds.minY = h / 2;
                    }
                }

                // Ï¥àÍ∏∞ ÏúÑÏπò ÏÑ§Ï†ï (Íµ¨Ïó≠ ÎÇ¥ ÎûúÎç§)
                // Î™¨Ïä§ÌÑ∞ ÌÅ¨Í∏∞(64px) Í≥†Î†§ÌïòÏó¨ Í≤ΩÍ≥Ñ ÏïàÏ™ΩÏóê ÏÉùÏÑ±
                const startX = bounds.minX + Math.random() * (bounds.maxX - bounds.minX - 70);
                const startY = bounds.minY + Math.random() * (bounds.maxY - bounds.minY - 70);

                const angle = Math.random() * Math.PI * 2;
                
                let baseSpeed = SPEED_MIN_BASE + Math.random() * (SPEED_MAX_BASE - SPEED_MIN_BASE);
                let speed = (baseSpeed + config.speedBonus) * (1 - (activeBenefits.slowPercent / 100));
                if (speed < 0.1) speed = 0.1;

                el.innerHTML = `${getMonsterHTML(type, colorSet.main, colorSet.dark)}<div class="number-badge">${i}</div>`;
                el.style.transform = `translate(${startX}px, ${startY}px)`;
                el.onmousedown = handleClick;
                el.ontouchstart = handleClick;
                gameArena.appendChild(el);

                const isDeadStart = i <= activeBenefits.initialKill;
                if (isDeadStart) {
                    el.classList.add('dead');
                    el.style.opacity = '0.3';
                    el.style.pointerEvents = 'none';
                }

                monsters.push({ 
                    el, x: startX, y: startY, 
                    vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, 
                    dead: isDeadStart,
                    id: i,
                    bounds: bounds // Ïù¥Îèô Ï†úÌïúÏùÑ ÏúÑÌï¥ bounds Ï†ÄÏû•
                });
            }

            if (activeBenefits.initialKill > 0) {
                currentTarget = 1 + activeBenefits.initialKill;
                if (currentTarget > totalMonstersInStage) {
                    setTimeout(handleStageClear, 500);
                }
            }
            updateStatusDisplay();
            resetHintTimer(); // ÏãúÏûë Ïãú ÌûåÌä∏ ÌÉÄÏù¥Î®∏ Í∞ÄÎèô
        }

        // --- Hint Logic ---
        function resetHintTimer() {
            if (hintTimer) clearTimeout(hintTimer);
            
            // Í∏∞Ï°¥ ÌûåÌä∏ Ï†úÍ±∞
            document.querySelectorAll('.hint-active').forEach(el => el.classList.remove('hint-active'));

            // Í≤åÏûÑÏù¥ Ïã§Ìñâ Ï§ëÏù¥Í≥†, Î∂àÎπõ Î†àÎ≤®Ïù¥ ÏûàÏùÑ ÎïåÎßå ÏûëÎèô
            if (activeBenefits.lightLevel > 0 && isGameRunning) {
                let delay = 2000;
                if (activeBenefits.lightLevel === 2) delay = 1500;
                if (activeBenefits.lightLevel >= 3) delay = 1000;

                hintTimer = setTimeout(() => {
                    const targetMonster = monsters.find(m => m.id === currentTarget && !m.dead);
                    if (targetMonster && targetMonster.el) {
                        targetMonster.el.classList.add('hint-active');
                    }
                }, delay);
            }
        }

        function startGame() {
            startScreen.style.display = 'none';
            createMonsters();
            isGameRunning = true; 
            resetHintTimer(); 
            
            startTime = performance.now();
            
            const timeLimit = DEFAULT_TIMEOUT_LIMIT + activeBenefits.timeExtension;

            timerInterval = setInterval(() => {
                const t = (performance.now() - startTime) / 1000;
                timerDisplay.textContent = t.toFixed(3);
                if (t > timeLimit) handleTimeOut();
            }, 10);
            
            if (!animId) loop();
        }
        
        function handleTimeOut() {
            isGameRunning = false;
            clearInterval(timerInterval);
            if (animId) { cancelAnimationFrame(animId); animId = null; }
            if (hintTimer) { clearTimeout(hintTimer); hintTimer = null; }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur pointer-events-auto';
            modal.innerHTML = `
                <div class="start-panel">
                    <div class="text-7xl mb-4">‚è∞</div>
                    <h2 class="text-3xl font-black text-red-500 mb-2">TIME OUT!</h2>
                    <p class="text-stone-600 mb-6 font-bold text-xl bg-white/80 p-2 rounded-lg">Ï†úÌïú ÏãúÍ∞Ñ Ï¥àÍ≥º!</p>
                    <button id="retry-btn" class="start-btn text-xl">TRY AGAIN</button>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('retry-btn').onclick = () => { modal.remove(); resetGame(); };
        }

        function updateStatusDisplay() {
            stageDisplay.textContent = currentStage;
            currentTargetDisplay.textContent = currentTarget;
            totalMonstersDisplay.textContent = totalMonstersInStage;
        }

        function loop() {
            if(isGameRunning) {
                const w = gameArena.clientWidth;
                const h = gameArena.clientHeight;
                monsters.forEach(m => {
                    if(m.dead) return;
                    m.x += m.vx; m.y += m.vy;
                    
                    // Íµ¨Ïó≠ Í≤ΩÍ≥Ñ(bounds) ÎÇ¥ÏóêÏÑúÎßå Ïù¥ÎèôÌïòÎèÑÎ°ù Ï†úÌïú (64pxÎäî Î™¨Ïä§ÌÑ∞ ÌÅ¨Í∏∞)
                    if(m.x <= m.bounds.minX || m.x >= m.bounds.maxX - 64) {
                        m.vx *= -1;
                        m.x = Math.max(m.bounds.minX, Math.min(m.x, m.bounds.maxX - 64));
                    }
                    if(m.y <= m.bounds.minY || m.y >= m.bounds.maxY - 64) {
                        m.vy *= -1;
                        m.y = Math.max(m.bounds.minY, Math.min(m.y, m.bounds.maxY - 64));
                    }
                    
                    m.el.style.transform = `translate(${m.x}px, ${m.y}px)`;
                    m.el.style.zIndex = Math.floor(m.y);
                    const body = m.el.querySelector('.monster-body');
                    if(m.vx > 0) body.style.transform = 'scaleX(-1)'; 
                    else body.style.transform = 'scaleX(1)'; 
                });
                animId = requestAnimationFrame(loop);
            } else { animId = null; }
        }

        function handleClick(e) {
            e.preventDefault();
            if(!isGameRunning) return;
            const el = e.currentTarget;
            const num = parseInt(el.dataset.number);
            const m = monsters.find(obj => obj.el === el);
            if(m.dead) return;

            if(num === currentTarget) {
                m.dead = true;
                el.classList.add('dead');
                el.classList.remove('hint-active'); 
                currentTarget++;
                resetHintTimer(); 

                if(currentTarget > totalMonstersInStage) handleStageClear();
                else updateStatusDisplay();
            } else {
                gameArena.classList.remove('shake-screen');
                void gameArena.offsetWidth;
                gameArena.classList.add('shake-screen');
                el.style.filter = 'brightness(2) saturate(2) hue-rotate(90deg)';
                setTimeout(() => el.style.filter = '', 150);
                setTimeout(() => gameArena.classList.remove('shake-screen'), 400);
            }
        }

        // --- Benefit & Bonus Round Logic ---
        
        function startBonusRound(limitTime) {
            bonusLayer.innerHTML = '';
            bonusLayer.style.display = 'flex';
            
            const intro = document.createElement('div');
            intro.className = 'start-panel';
            intro.innerHTML = `
                <h2 class="text-4xl font-black text-red-500 mb-2">‚ö†Ô∏è WARNING!</h2>
                <p class="text-stone-600 mb-4 font-bold text-lg">Í±∞ÎåÄ Î™¨Ïä§ÌÑ∞ Ï∂úÌòÑ!</p>
                <p class="text-green-600 text-sm mb-6">ÎÇòÌÉÄÎÇòÎäî ÏàúÍ∞Ñ ${limitTime}Ï¥à ÏïàÏóê ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî!</p>
                <button id="bonus-ready-btn" class="start-btn text-xl">READY</button>
            `;
            bonusLayer.appendChild(intro);

            document.getElementById('bonus-ready-btn').onclick = () => {
                intro.remove();
                
                const waitTime = 1000 + Math.random() * 2000;
                setTimeout(() => {
                    spawnGiantMonster(limitTime);
                }, waitTime);
            };
        }

        function spawnGiantMonster(limitTime) {
            const monster = document.createElement('div');
            monster.className = 'monster-entity giant-monster';
            monster.innerHTML = getMonsterHTML('slime', '#ff0000', '#990000');
            
            const w = window.innerWidth;
            const h = window.innerHeight;
            const x = Math.random() * (w - 250) + 25;
            const y = Math.random() * (h - 250) + 125;
            monster.style.left = `${x}px`;
            monster.style.top = `${y}px`;
            
            bonusLayer.appendChild(monster);
            
            const spawnTime = performance.now();
            
            monster.onmousedown = monster.ontouchstart = (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const clickTime = performance.now();
                const duration = (clickTime - spawnTime) / 1000;
                
                monster.remove();
                
                if (duration <= limitTime) {
                    showBonusResult(true, duration, 2);
                } else {
                    showBonusResult(false, duration, 1);
                }
            };
        }

        function showBonusResult(success, time, picks) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'start-panel';
            resultDiv.style.zIndex = 200;
            
            const title = success ? "SUCCESS! üéâ" : "TOO SLOW... üê¢";
            const color = success ? "text-green-500" : "text-stone-500";
            
            resultDiv.innerHTML = `
                <h2 class="text-4xl font-black ${color} mb-2">${title}</h2>
                <p class="text-stone-600 mb-2 font-bold">Î∞òÏùë ÏÜçÎèÑ: ${time.toFixed(3)}Ï¥à</p>
                <p class="text-stone-500 mb-6 text-sm">Î≥¥ÏÉÅ: Î≤†ÎÑ§Ìïè ${picks}Í∞ú ÏÑ†ÌÉù Í∞ÄÎä•</p>
                <button id="bonus-ok-btn" class="start-btn text-xl">ÌôïÏù∏</button>
            `;
            bonusLayer.appendChild(resultDiv);
            
            document.getElementById('bonus-ok-btn').onclick = () => {
                bonusLayer.innerHTML = '';
                bonusLayer.style.display = 'none';
                showBenefitModal(picks);
            };
        }

        function showBenefitModal(pickCount) {
            const benefits = generateBenefits();
            let picksLeft = pickCount;

            const modal = document.createElement('div');
            modal.id = 'clear-modal';
            modal.className = 'fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur pointer-events-auto';
            
            const updateUI = () => {
                let cardsHtml = benefits.map((b, index) => `
                    <div class="benefit-card ${b.cssClass} ${b.picked ? 'selected' : ''}" data-index="${index}">
                        <div class="card-icon">${b.icon}</div>
                        <div class="card-title">${b.title}</div>
                        <div class="card-desc">${b.desc}</div>
                    </div>
                `).join('');

                modal.innerHTML = `
                    <div class="start-panel" style="max-width: 600px;">
                        <div class="text-6xl mb-2">üéâ</div>
                        <h2 class="text-3xl font-black text-white mb-2">STAGE ${currentStage} CLEAR!</h2>
                        <p class="text-yellow-300 font-bold mb-2 text-xl">Î≥¥ÏÉÅÏùÑ ${picksLeft}Í∞ú ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!</p>
                        <div class="benefit-container">${cardsHtml}</div>
                    </div>
                `;
                
                modal.querySelectorAll('.benefit-card').forEach(card => {
                    if(!card.classList.contains('selected')) {
                        card.onclick = () => {
                            const idx = card.dataset.index;
                            applyBenefit(benefits[idx]);
                            benefits[idx].picked = true;
                            picksLeft--;
                            
                            if (picksLeft <= 0) {
                                modal.remove();
                                loadStageConfig(currentStage + 1);
                                updateStatusDisplay();
                                startGame();
                            } else {
                                updateUI();
                            }
                        };
                    }
                });
            };
            
            document.body.appendChild(modal);
            updateUI();
        }

        function generateBenefits() {
            const nextStageConfig = getStageConfig(currentStage + 1);
            let availableTypes = [BENEFIT_TYPES.KILL, BENEFIT_TYPES.SLOW, BENEFIT_TYPES.TIME];
            
            if (currentStage >= 3) {
                if (nextStageConfig.bushCount > 0) availableTypes.push(BENEFIT_TYPES.REMOVE_BUSH);
                if (activeBenefits.fenceLevel < 2) availableTypes.push(BENEFIT_TYPES.FENCE);
                if (activeBenefits.lightLevel < 3) availableTypes.push(BENEFIT_TYPES.LIGHT);
            }

            for (let i = availableTypes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [availableTypes[i], availableTypes[j]] = [availableTypes[j], availableTypes[i]];
            }

            const selectedTypes = availableTypes.slice(0, 3);
            const options = [];

            selectedTypes.forEach(type => {
                let rarity, value, title, desc, icon, cssClass;
                if (type === BENEFIT_TYPES.REMOVE_BUSH) {
                    rarity = 'rare'; value = 1; cssClass = 'rarity-rare'; title = "Ï†úÏ¥à ÏûëÏóÖ"; desc = "Îã§ÏùåÎ∂ÄÌÑ∞ ÌíÄÏà≤ 1Í∞ú Ï†úÍ±∞"; icon = "‚úÇÔ∏è";
                } else if (type === BENEFIT_TYPES.FENCE) {
                    rarity = 'legend'; value = 1; cssClass = 'rarity-legend'; title = "Ïö∏ÌÉÄÎ¶¨ ÏÑ§Ïπò"; desc = "Î™¨Ïä§ÌÑ∞Î•º Íµ¨Ïó≠Î≥ÑÎ°ú Ï†ïÎ†¨"; icon = "üöß";
                } else if (type === BENEFIT_TYPES.LIGHT) {
                    rarity = 'rare'; value = 1; cssClass = 'rarity-rare'; title = "Î∂àÎπõ ÌûåÌä∏"; 
                    const sec = activeBenefits.lightLevel === 0 ? 2 : (activeBenefits.lightLevel === 1 ? 1.5 : 1);
                    desc = `${sec}Ï¥à ÏßÄÏó∞ Ïãú ÌûåÌä∏ ÌëúÏãú`; icon = "üí°";
                } else {
                    const randRarity = Math.random();
                    if (type === BENEFIT_TYPES.KILL) {
                        if (randRarity < 0.7) { rarity = 'normal'; value = 1; cssClass = 'rarity-normal'; }
                        else if (randRarity < 0.9) { rarity = 'rare'; value = 2; cssClass = 'rarity-rare'; }
                        else { rarity = 'legend'; value = 3; cssClass = 'rarity-legend'; }
                        title = "ÏãúÏûë ÌÇ¨"; desc = `ÏãúÏûë Ïãú Î™¨Ïä§ÌÑ∞ ${value}ÎßàÎ¶¨ ÏûêÎèô Ï≤òÏπò`; icon = "‚öîÔ∏è";
                    } else if (type === BENEFIT_TYPES.SLOW) {
                        if (randRarity < 0.8) { rarity = 'normal'; value = 10; cssClass = 'rarity-normal'; }
                        else if (randRarity < 0.95) { rarity = 'rare'; value = 20; cssClass = 'rarity-rare'; }
                        else { rarity = 'legend'; value = 30; cssClass = 'rarity-legend'; }
                        title = "ÏÜçÎèÑ Í∞êÏÜå"; desc = `Î™®Îì† Î™¨Ïä§ÌÑ∞ ÏÜçÎèÑ ${value}% Í∞êÏÜå`; icon = "üêå";
                    } else if (type === BENEFIT_TYPES.TIME) {
                        if (randRarity < 0.8) { rarity = 'normal'; value = 5; cssClass = 'rarity-normal'; }
                        else if (randRarity < 0.95) { rarity = 'rare'; value = 10; cssClass = 'rarity-rare'; }
                        else { rarity = 'legend'; value = 15; cssClass = 'rarity-legend'; }
                        title = "ÏãúÍ∞Ñ Ïó∞Ïû•"; desc = `Ï†úÌïú ÏãúÍ∞Ñ ${value}Ï¥à Ï¶ùÍ∞Ä`; icon = "‚è≥";
                    }
                }
                options.push({ type, rarity, value, title, desc, icon, cssClass, picked: false });
            });
            return options;
        }

        function applyBenefit(benefit) {
            if (benefit.type === BENEFIT_TYPES.KILL) activeBenefits.initialKill += benefit.value;
            if (benefit.type === BENEFIT_TYPES.SLOW) activeBenefits.slowPercent += benefit.value;
            if (benefit.type === BENEFIT_TYPES.TIME) activeBenefits.timeExtension += benefit.value;
            if (benefit.type === BENEFIT_TYPES.REMOVE_BUSH) activeBenefits.bushRemoval += benefit.value;
            if (benefit.type === BENEFIT_TYPES.FENCE) activeBenefits.fenceLevel += 1;
            if (benefit.type === BENEFIT_TYPES.LIGHT) activeBenefits.lightLevel += 1;
            updateActiveBenefitsUI();
        }

        function updateActiveBenefitsUI() {
            activeBenefitsEl.innerHTML = '';
            if (activeBenefits.initialKill > 0) activeBenefitsEl.innerHTML += `<div class="active-benefit-item"><span>‚öîÔ∏è</span><span>${activeBenefits.initialKill}</span></div>`;
            if (activeBenefits.slowPercent > 0) activeBenefitsEl.innerHTML += `<div class="active-benefit-item"><span>üêå</span><span>-${activeBenefits.slowPercent}%</span></div>`;
            if (activeBenefits.timeExtension > 0) activeBenefitsEl.innerHTML += `<div class="active-benefit-item"><span>‚è≥</span><span>+${activeBenefits.timeExtension}s</span></div>`;
            if (activeBenefits.bushRemoval > 0) activeBenefitsEl.innerHTML += `<div class="active-benefit-item"><span>‚úÇÔ∏è</span><span>-${activeBenefits.bushRemoval}</span></div>`;
            if (activeBenefits.fenceLevel > 0) activeBenefitsEl.innerHTML += `<div class="active-benefit-item"><span>üöß</span><span>Lv.${activeBenefits.fenceLevel}</span></div>`;
            if (activeBenefits.lightLevel > 0) activeBenefitsEl.innerHTML += `<div class="active-benefit-item"><span>üí°</span><span>Lv.${activeBenefits.lightLevel}</span></div>`;
        }

        async function handleStageClear() {
            isGameRunning = false;
            clearInterval(timerInterval);
            if (animId) { cancelAnimationFrame(animId); animId = null; }
            if (hintTimer) { clearTimeout(hintTimer); hintTimer = null; }

            const score = timerDisplay.textContent;
            if(db) await addDoc(collection(db, COLLECTION_PATH), { stage: currentStage, time: parseFloat(score), timestamp: serverTimestamp() });

            if (currentStage === 3) {
                startBonusRound(0.6); // 0.4 -> 0.6s
                return;
            }
            if (currentStage === 5) {
                startBonusRound(0.5); // 0.3 -> 0.5s
                return;
            }
            if (currentStage === 8) {
                startBonusRound(0.48); // 0.28 -> 0.48s
                return;
            }

            showBenefitModal(1);
        }

        function setupLeaderboard() {
            if(!db) return;
            onSnapshot(collection(db, COLLECTION_PATH), snap => {
                const list = [];
                snap.forEach(d => list.push(d.data()));
                list.sort((a,b) => b.stage !== a.stage ? b.stage - a.stage : a.time - b.time);
                leaderboardEl.innerHTML = list.slice(0,5).map((s, i) => `
                    <li class="flex justify-between items-center p-2 bg-white/10 rounded-lg mb-1">
                        <span class="${i<3 ? 'text-yellow-400 font-bold' : 'text-stone-300'}">${i+1}. LV.${s.stage}</span>
                        <span class="font-mono font-bold text-green-300">${s.time.toFixed(2)}s</span>
                    </li>
                `).join('') || '<li class="text-center text-stone-400 text-xs py-2 italic">Í∏∞Î°ù ÏóÜÏùå</li>';
            });
        }

        init();
    </script>
</body>
</html>
